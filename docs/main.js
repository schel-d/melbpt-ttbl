!function r(e,n,t){function o(i,f){if(!n[i]){if(!e[i]){var c="function"==typeof require&&require;if(!f&&c)return c(i,!0);if(u)return u(i,!0);throw(f=new Error("Cannot find module '"+i+"'")).code="MODULE_NOT_FOUND",f}c=n[i]={exports:{}},e[i][0].call(c.exports,function(r){return o(e[i][1][r]||r)},c,c.exports,r,e,n,t)}return n[i].exports}for(var u="function"==typeof require&&require,i=0;i<t.length;i++)o(t[i]);return o}({1:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.AppContext=void 0;const editor_1=require("./editor/editor"),header_1=require("./components/header"),new_timetable_dialog_1=require("./components/new-timetable-dialog"),paste_issues_dialog_1=require("./components/paste-issues-dialog"),timetable_1=require("./data/timetable"),week_day_range_1=require("./data/week-day-range"),validator_1=require("./validator"),export_1=require("./data/export"),utils_1=require("./utils"),dom_utils_1=require("./dom-utils"),main_1=require("./main");exports.AppContext=class{constructor(e,t){this.network=e,this.timetable=null,this.status=t,this.validator=new validator_1.Validator(e,e=>this.onValidatorResults(e)),this.editor=new editor_1.Editor(e=>this.onValidationRequest(e)),this.header=new header_1.Header(()=>this.onNewButtonClicked(),()=>this.onImportButtonClicked(),()=>this.onExportButtonClicked()),this.newTimetableDialog=new new_timetable_dialog_1.NewTimetableDialog(e),this.pasteIssuesDialog=new paste_issues_dialog_1.PasteIssuesDialog,this.status.ready(),this.header.ready(),this.editor.clear()}onNewButtonClicked(){null!=this.timetable&&this.timetable.hasContent()&&!confirm("Create a new timetable? This one won't be saved anywhere.")||this.newTimetableDialog.show((e,t,i)=>this.onNTDSubmitted(e,t,i))}onImportButtonClicked(){alert("Importing timetables is not implemented yet.")}onExportButtonClicked(){try{if(null==this.timetable)throw new Error("Timetable is null, nothing to export.");(0,export_1.exportTimetable)(this.timetable,this.network)}catch(e){alert("Error: "+(0,utils_1.getErrorMessage)(e))}}onNTDSubmitted(e,t,i){i=parseInt(i,36),t=week_day_range_1.WDRPresets[t],i=new timetable_1.Timetable(i,e,t,this.network);this.editTimetable(i)}editTimetable(e){this.timetable=e,this.header.editing(e.generalDirs,e.wdrs,(t,i)=>{t=e.getTimetableSection(t,i);this.editor.setSection(t,this.network)}),this.status.editing();var t=e.getFirstSection();this.editor.setSection(t,this.network),this.header.selectTab(t.generalDir,t.wdr)}onValidationRequest(e){null!=this.timetable&&this.validator.requestValidation(e,this.timetable.lineID)}onValidatorResults(e){const t=(0,dom_utils_1.getParagraph)(main_1.HtmlIDs.footerError),i=e.overallError();null==i?(t.classList.remove("error"),t.textContent="Valid timetable"):(t.classList.add("error"),t.textContent=i),this.editor.applyValidationOverlay(e)}}},{"./components/header":16,"./components/new-timetable-dialog":17,"./components/paste-issues-dialog":18,"./data/export":21,"./data/timetable":27,"./data/week-day-range":28,"./dom-utils":29,"./editor/editor":34,"./main":35,"./utils":36,"./validator":37}],2:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.AltArrowsHandler=void 0;const utils_1=require("../utils"),command_handler_1=require("./command-handler");class AltArrowsHandler extends command_handler_1.CommandHandler{constructor(){super([(0,command_handler_1.keyFilter)({key:"ArrowLeft",alt:!0}),(0,command_handler_1.keyFilter)({key:"ArrowRight",alt:!0})])}handle(e,r,t,i,s,c){const l=c.editor.section,o=c.editor.grid;if(null!=l&&0!=l.width&&null!=o.selectedRange){const{x1:n,y1:d,x2:a,y2:h}=o.selectedRange;if(0==d&&h==l.height-1){if("ArrowLeft"==r&&0<n){const e=n==a?"Shift service left":"Shift services left";l.edit(e,e=>{const r=e.service(n-1);for(const r of(0,utils_1.range)(n,a+1))e.replaceService(e.service(r),r-1);e.replaceService(r,a)}),o.select(n-1,0,a-1,l.height-1)}if("ArrowRight"==r&&a<l.width-1){const e=n==a?"Shift service right":"Shift services right";l.edit(e,e=>{const r=e.service(a+1);for(const r of(0,utils_1.range)(n,a+1))e.replaceService(e.service(r),r+1);e.replaceService(r,n)}),o.select(n+1,0,a+1,l.height-1)}}}}}exports.AltArrowsHandler=AltArrowsHandler},{"../utils":36,"./command-handler":3}],3:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.CommandHandler=exports.keyFilter=void 0,exports.keyFilter=function(l){var e;return{char:null!=(e=l.char)?e:null,key:null!=(e=l.key)?e:null,ctrl:"*"==l.ctrl?null:null!=(e=l.ctrl)&&e,alt:"*"==l.alt?null:null!=(e=l.alt)&&e,shift:"*"==l.shift?null:null!=(e=l.shift)&&e}};exports.CommandHandler=class{constructor(l){this.acceptedFilters=l}}},{}],4:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.CommandListener=void 0;const select_arrows_handler_1=require("./select-arrows-handler"),tab_handler_1=require("./tab-handler"),extract_content_1=require("./extract-content"),toast_1=require("../components/toast"),enter_handler_1=require("./enter-handler"),delete_handler_1=require("./delete-handler"),select_all_handler_1=require("./select-all-handler"),undo_handler_1=require("./undo-handler"),alt_arrows_handler_1=require("./alt-arrows-handler"),text_entry_handler_1=require("./text-entry-handler"),new_service_handler_1=require("./new-service-handler"),space_handler_1=require("./space-handler"),next_day_handler_1=require("./next-day-handler"),timetable_data_1=require("../data/timetable-data");exports.CommandListener=class{constructor(e){this._appContext=e,this._handlers=[new select_arrows_handler_1.SelectArrowsHandler,new tab_handler_1.TabHandler,new enter_handler_1.EnterHandler,new delete_handler_1.DeleteHandler,new select_all_handler_1.SelectAllHandler,new undo_handler_1.UndoHandler,new alt_arrows_handler_1.AltArrowsHandler,new text_entry_handler_1.TextEntryHandler,new new_service_handler_1.NewServiceHandler,new space_handler_1.SpaceHandler,new next_day_handler_1.NextDayHandler]}onKey(e,t,n,r,a){const l=this._handlers.find(l=>l.acceptedFilters.some(l=>!(null!=l.char&&l.char!=e||null!=l.key&&l.key!=t||null!=l.ctrl&&l.ctrl!=n||null!=l.alt&&l.alt!=r||null!=l.shift&&l.shift!=a&&null==l.char)));return null!=l&&(l.handle(e,t,n,r,a,this._appContext),!0)}onDocKeyEvent(e){this._appContext.newTimetableDialog.isOpen()||this._appContext.pasteIssuesDialog.isOpen()||"Control"!=e.key&&"Meta"!=e.key&&"Alt"!=e.key&&"Shift"!=e.key&&!this.onKey(e.key,e.code,e.ctrlKey||e.metaKey,e.altKey,e.shiftKey)||e.preventDefault()}onPaste(e){const r=this._appContext.editor.section,a=this._appContext.newTimetableDialog,l=this._appContext.pasteIssuesDialog,s=this._appContext.network;if(null!=r&&!a.isOpen()&&!l.isOpen()){var t=null!=(t=null==(t=e.clipboardData)?void 0:t.getData("text"))?t:"";if(0!=t.length){e.preventDefault();const o=r.stops.map(e=>s.stopName(e));(0,extract_content_1.extractContent)(t,o,l,(e,t)=>{o.length-t.length<=1?(0,toast_1.createToast)("That didn't seem like timetable content."):(r.edit("Paste timetable content",t=>{t.addServices(e.map(e=>new timetable_data_1.Service(e,!1)))}),3<t.length?(0,toast_1.createToast)(t.length+" stops were missing from the pasted content."):0!=t.length&&(0,toast_1.createToast)(`${t.join(", ")} ${1==t.length?"was":"were"} `+"missing from the pasted content."))})}}}}},{"../components/toast":20,"../data/timetable-data":24,"./alt-arrows-handler":2,"./delete-handler":5,"./enter-handler":6,"./extract-content":7,"./new-service-handler":8,"./next-day-handler":9,"./select-all-handler":10,"./select-arrows-handler":11,"./space-handler":12,"./tab-handler":13,"./text-entry-handler":14,"./undo-handler":15}],5:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.DeleteHandler=void 0;const command_handler_1=require("./command-handler");class DeleteHandler extends command_handler_1.CommandHandler{constructor(){super([(0,command_handler_1.keyFilter)({key:"Delete",ctrl:"*"})])}handle(e,t,l,r,d,n){const s=n.editor.section,a=n.editor.grid;if(null!=s&&null!=a.selected){const{startX:c,startY:o,endX:i,endY:m}=a.selected;if(0!=o||m!=s.height-1||l)s.edit("Delete text",e=>{e.modifyCells(c,o,i,m,()=>"")});else{const e=c==i?"Delete service":"Delete services";s.edit(e,e=>{e.deleteServices(Math.min(c,i),Math.max(c,i)+1)}),a.clearSelection()}}}}exports.DeleteHandler=DeleteHandler},{"./command-handler":3}],6:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.EnterHandler=void 0;const command_handler_1=require("./command-handler");class EnterHandler extends command_handler_1.CommandHandler{constructor(){super([(0,command_handler_1.keyFilter)({key:"Enter"})])}handle(e,r,n,t,d,l){const s=l.editor.section,o=l.editor.grid;if(null!=s&&null!=o.selected){const{startX:a,startY:c,endX:i,endY:m}=o.selected;s.edit("Fill empty cells",e=>{e.modifyCells(a,c,i,m,e=>""===e?"-":e)})}}}exports.EnterHandler=EnterHandler},{"./command-handler":3}],7:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.extractContent=void 0;const utils_1=require("../utils"),timetableRowRegex=/^.+( +(([0-9]{1,2}[:.][0-9]{2}(am|pm|[uda])?)|-))+$/,timesOnlyRegex=/( +(([0-9]{1,2}[:.][0-9]{2}(am|pm|[uda])?)|-))+$/;exports.extractContent=function(t,e,n,o){!function(t,e,n,o){const r=[],s=[],i={};for(let n=0;n<e.length;n++){const o=e[n],l=t.filter(t=>t.stop===o);1==l.length?i[n]=l[0].times:0==l.length?(i[n]=null,r.push(o)):(i[n]=null,s.push({stopName:o,rowIndex:n,options:l}))}0<s.length?n.show(s,t=>{for(const e of t)i[e.rowIndex]=e.option.times;o(i,r)}):o(i,r)}(function(t,e){return(t=t.toLowerCase().replace(/[-–—]/g,"-")).split("\n").map(t=>t.replace(/\s+/g," ").trim()).filter(t=>timetableRowRegex.test(t)).map(t=>{var n;const o=t.split(timesOnlyRegex)[0],r=e.find(t=>function(t,e){return(t=t.toLowerCase().trim())===(e=e.toLowerCase())||t.startsWith(e)&&/^ (dep|arr|station|stn\.?|\([0-9]+\))$/g.test(t.substring(e.length))}(o,t)),s=null==(n=timesOnlyRegex.exec(t))?void 0:n.index;if(null==s)throw new Error("Row that was believed to be timetable was not in correct format");return{stop:r,times:t.substring(s).trim().split(" "),header:o}}).filter(t=>null!=t.stop)}(t,e),e,n,(t,e)=>{t=function(t){const e=Object.keys(t).map(e=>t[parseInt(e)]).filter(t=>null!=t),n=Math.max(...e.map(t=>t.length)),o=Object.keys(t).length,r=[];for(let e=0;e<o;e++){const o=t[e];for(let t=0;t<n;t++)null==r[t]&&(r[t]=[]),null==o||o.length<=t?r[t][e]="":r[t][e]=function(t){return"-"===t?"-":(t=t.replace(".",":").replace(/[ uda]\b/,""),null!=(t=(0,utils_1.standardizeTimeString)(t))?t:"?")}(o[t])}return r}(t);o(t,e)})}},{"../utils":36}],8:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.NewServiceHandler=void 0;const timetable_data_1=require("../data/timetable-data"),utils_1=require("../utils"),command_handler_1=require("./command-handler");class NewServiceHandler extends command_handler_1.CommandHandler{constructor(){super([(0,command_handler_1.keyFilter)({key:"KeyN",shift:!0})])}handle(e,r,t,a,d,i){const n=i.editor.section;null!=n&&n.edit("Add empty service",e=>{e.addServices([new timetable_data_1.Service((0,utils_1.repeat)("",n.height),!1)])})}}exports.NewServiceHandler=NewServiceHandler},{"../data/timetable-data":24,"../utils":36,"./command-handler":3}],9:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.NextDayHandler=void 0;const utils_1=require("../utils"),command_handler_1=require("./command-handler");class NextDayHandler extends command_handler_1.CommandHandler{constructor(){super([(0,command_handler_1.keyFilter)({key:"KeyM",shift:!0})])}handle(e,t,r,n,a,d){const s=d.editor.section,l=d.editor.grid;if(null!=s&&null!=l.selected){const{startX:o,startY:i,endX:c,endY:u}=l.selected;if(0==i&&u==s.height-1){const x=s.nextDay(o);s.edit("Toggle next day",e=>{(0,utils_1.range)(o,c+1).forEach(t=>e.setNextDay(t,!x))})}}}}exports.NextDayHandler=NextDayHandler},{"../utils":36,"./command-handler":3}],10:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.SelectAllHandler=void 0;const command_handler_1=require("./command-handler");class SelectAllHandler extends command_handler_1.CommandHandler{constructor(){super([(0,command_handler_1.keyFilter)({key:"KeyA",ctrl:!0})])}handle(e,l,r,t,d,n){const c=n.editor.section,o=n.editor.grid;null!=c&&0!=c.width&&o.select(0,0,c.width-1,c.height-1)}}exports.SelectAllHandler=SelectAllHandler},{"./command-handler":3}],11:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.SelectArrowsHandler=void 0;const utils_1=require("../utils"),command_handler_1=require("./command-handler");class SelectArrowsHandler extends command_handler_1.CommandHandler{constructor(){super([(0,command_handler_1.keyFilter)({key:"ArrowUp",ctrl:"*",shift:"*"}),(0,command_handler_1.keyFilter)({key:"ArrowDown",ctrl:"*",shift:"*"}),(0,command_handler_1.keyFilter)({key:"ArrowLeft",ctrl:"*",shift:"*"}),(0,command_handler_1.keyFilter)({key:"ArrowRight",ctrl:"*",shift:"*"})])}handle(e,r,t,o,l,s){const d=s.editor.section,n=s.editor.grid;if(null!=d&&0!=d.width&&null!=n.selected){let c=0,i="ArrowDown"==r?1:"ArrowUp"==r?-1:0;"ArrowLeft"==r&&(c=-1),"ArrowRight"==r&&(c=1);var{startX:s,startY:r,endX:m,endY:w}=n.selected;if(l){const e=this.coordsFromOffset(d,m,w,c,i,t);void n.select(s,r,e.x,e.y)}else{l=this.coordsFromOffset(d,s,r,c,i,t);n.select(l.x,l.y,l.x,l.y)}}}coordsFromOffset(e,r,t,o,l,s){return s&&(o*=e.width,l*=e.height),{x:(0,utils_1.clamp)(r+o,0,e.width-1),y:(0,utils_1.clamp)(t+l,0,e.height-1)}}}exports.SelectArrowsHandler=SelectArrowsHandler},{"../utils":36,"./command-handler":3}],12:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.SpaceHandler=void 0;const utils_1=require("../utils"),command_handler_1=require("./command-handler");class SpaceHandler extends command_handler_1.CommandHandler{constructor(){super([(0,command_handler_1.keyFilter)({key:"Space"})])}handle(e,l,r,a,t,n){const d=n.editor.section,c=n.editor.grid;if(null!=d&&0!=d.width&&null!=c.selectedRange){const{x1:s,y1:i,y2:o}=c.selectedRange;(0,utils_1.range)(i,o+1).every(e=>""!=d.cell(s,e)&&(0,utils_1.range)(s+1,d.width).some(l=>""==d.cell(l,e)))&&(d.edit("Fill timetable gap",e=>{(0,utils_1.range)(i,o+1).forEach(l=>{for(let r=d.map(e=>e.times[l]).findIndex(e=>""==e);r>=s;r--)r==s?e.replaceCell(r,l,"-"):e.replaceCell(r,l,d.cell(r-1,l))})}),c.select(s+1,i,s+1,o))}}}exports.SpaceHandler=SpaceHandler},{"../utils":36,"./command-handler":3}],13:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.TabHandler=void 0;const command_handler_1=require("./command-handler");class TabHandler extends command_handler_1.CommandHandler{constructor(){super([(0,command_handler_1.keyFilter)({key:"Tab",shift:"*"})])}handle(e,t,s,l,d,i){var o,n,c,a,h=i.editor.section,i=i.editor.grid;null!=h&&0!=h.width&&(null==i.selected?d?this.selectCol(i,h,h.width-1):this.selectCol(i,h,0):({startX:o,startY:n,endX:c,endY:a}=i.selected,0!=n||a!=h.height-1?0!=o||c!=h.width-1?this.selectCol(i,h,o):d?this.selectRow(i,h,(n-1+h.height)%h.height):this.selectRow(i,h,(n+1)%h.height):d?this.selectCol(i,h,(o-1+h.width)%h.width):this.selectCol(i,h,(o+1)%h.width)))}selectCol(e,t,s){e.select(s,0,s,t.height-1)}selectRow(e,t,s){e.select(0,s,t.width-1,s)}}exports.TabHandler=TabHandler},{"./command-handler":3}],14:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.TextEntryHandler=void 0;const command_handler_1=require("./command-handler");class TextEntryHandler extends command_handler_1.CommandHandler{constructor(){super([(0,command_handler_1.keyFilter)({char:"0"}),(0,command_handler_1.keyFilter)({char:"1"}),(0,command_handler_1.keyFilter)({char:"2"}),(0,command_handler_1.keyFilter)({char:"3"}),(0,command_handler_1.keyFilter)({char:"4"}),(0,command_handler_1.keyFilter)({char:"5"}),(0,command_handler_1.keyFilter)({char:"6"}),(0,command_handler_1.keyFilter)({char:"7"}),(0,command_handler_1.keyFilter)({char:"8"}),(0,command_handler_1.keyFilter)({char:"9"}),(0,command_handler_1.keyFilter)({char:"-"}),(0,command_handler_1.keyFilter)({char:":"}),(0,command_handler_1.keyFilter)({key:"Backspace"})])}handle(e,r,a,n,d,l){const t=l.editor.section,c=l.editor.grid;if(null!=t&&null!=c.selected){const{startX:m,startY:o,endX:h,endY:_}=c.selected;m==h&&o==_||c.select(m,o),t.edit("Edit cell",a=>{"Backspace"==r?a.modifyCell(m,o,e=>0==e.length?e:e.substring(0,e.length-1)):a.modifyCell(m,o,r=>5<=r.length?r:r+e)})}}}exports.TextEntryHandler=TextEntryHandler},{"./command-handler":3}],15:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.UndoHandler=void 0;const toast_1=require("../components/toast"),command_handler_1=require("./command-handler");class UndoHandler extends command_handler_1.CommandHandler{constructor(){super([(0,command_handler_1.keyFilter)({key:"KeyZ",ctrl:!0,shift:"*"}),(0,command_handler_1.keyFilter)({key:"KeyY",ctrl:!0})])}handle(e,t,n,o,r,a){const d=a.editor.section;if(null!=d)if("KeyY"==t||r){const e=d.redo();null!=e?(0,toast_1.createToast)("Redone: "+e):(0,toast_1.createToast)("Cannot redo any further")}else{const e=d.undo();null!=e?(0,toast_1.createToast)("Undone: "+e):(0,toast_1.createToast)("Cannot undo any further")}}}exports.UndoHandler=UndoHandler},{"../components/toast":20,"./command-handler":3}],16:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.Header=void 0;const week_day_range_1=require("../data/week-day-range"),dom_utils_1=require("../dom-utils"),main_1=require("../main"),generalDirNames={up:"Up",down:"Down"};exports.Header=class{constructor(e,t,n){this._newButton=(0,dom_utils_1.getButton)(main_1.HtmlIDs.headerNewTimetableButton),this._newButton.addEventListener("click",()=>e()),this._importButton=(0,dom_utils_1.getButton)(main_1.HtmlIDs.headerImportButton),this._importButton.addEventListener("click",()=>t()),this._exportButton=(0,dom_utils_1.getButton)(main_1.HtmlIDs.headerExportButton),this._exportButton.addEventListener("click",()=>n()),this.tabs=(0,dom_utils_1.getDiv)(main_1.HtmlIDs.headerTabs)}ready(){this._newButton.disabled=!1,this._importButton.disabled=!1,this._exportButton.disabled=!0,this.tabs.replaceChildren()}editing(e,t,n){this._newButton.disabled=!1,this._importButton.disabled=!1,this._exportButton.disabled=!1,this.tabs.replaceChildren(...e.map(e=>function(e,t,n){const a=document.createElement("div"),o=(a.className="tab-group",a.id="tab-group-"+e,document.createElement("div")),r=(o.className="tab-group-header",document.createElement("p"));return r.textContent=generalDirNames[e]+":",o.append(r),a.append(o),a.append(...t.map(t=>function(e,t,n){const a=document.createElement("label"),o=(a.className="tab",document.createElement("input")),r=(o.type="radio",o.name="tab",o.autocomplete="off",o.value=t,o.addEventListener("click",()=>n(e,t)),document.createElement("div")),i=(r.className="tab-content",document.createElement("p"));return i.textContent=(0,week_day_range_1.nameWDR)(t),r.append(i),a.append(o,r),a}(e,t,n))),a}(e,t,n)))}selectTab(e,t){document.querySelector(`#tab-group-${e} input[value="${t}"]`).checked=!0}}},{"../data/week-day-range":28,"../dom-utils":29,"../main":35}],17:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.NewTimetableDialog=void 0;const week_day_range_1=require("../data/week-day-range"),dom_utils_1=require("../dom-utils"),main_1=require("../main"),utils_1=require("../utils");exports.NewTimetableDialog=class{constructor(t){this._dialog=document.getElementById(main_1.HtmlIDs.newTimetableDialog),this._cancelButton=(0,dom_utils_1.getButton)(main_1.HtmlIDs.newTimetableCancelButton),this._submitButton=(0,dom_utils_1.getButton)(main_1.HtmlIDs.newTimetableSubmitButton),this._linesSelect=(0,dom_utils_1.getSelect)(main_1.HtmlIDs.newTimetableLinesSelect),this._wdrsSelect=(0,dom_utils_1.getSelect)(main_1.HtmlIDs.newTimetableWDRsSelect),this._idInput=(0,dom_utils_1.getInput)(main_1.HtmlIDs.newTimetableIdInput),this._errorText=(0,dom_utils_1.getParagraph)(main_1.HtmlIDs.newTimetableErrorText),this._submittedCallback=null,this.populateInputs(t),this._cancelButton.addEventListener("click",()=>this._dialog.close()),this._submitButton.addEventListener("click",()=>this.onSubmitClick())}show(t){this._submittedCallback=t,this._dialog.showModal(),this._errorText.textContent=""}isOpen(){return 1==this._dialog.open}populateInputs(t){t=[...t.lines].sort((t,e)=>t.name.localeCompare(e.name)).map(t=>new Option(t.name,t.id.toString())),this._linesSelect.replaceChildren(...t),t=week_day_range_1.WDRPresets.map((t,e)=>new Option(t.map(t=>(0,week_day_range_1.nameWDR)(t)).join(", "),e.toString()));this._wdrsSelect.replaceChildren(...t)}onSubmitClick(){var t=this._linesSelect.value,e=this._wdrsSelect.value,i=this._idInput.value,l=parseInt(t),e=parseInt(e);try{null!=this._submittedCallback&&this._submittedCallback(l,e,i),this._dialog.close(),this._errorText.textContent=""}catch(t){this._errorText.textContent=(0,utils_1.getErrorMessage)(t)}}}},{"../data/week-day-range":28,"../dom-utils":29,"../main":35,"../utils":36}],18:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.PasteIssuesDialog=void 0;const dom_utils_1=require("../dom-utils"),main_1=require("../main");exports.PasteIssuesDialog=class{constructor(){this._dialog=document.getElementById(main_1.HtmlIDs.pasteIssuesDialog),this._cancelButton=(0,dom_utils_1.getButton)(main_1.HtmlIDs.pasteIssuesCancelButton),this._submitButton=(0,dom_utils_1.getButton)(main_1.HtmlIDs.pasteIssuesSubmitButton),this._duplicatesDiv=(0,dom_utils_1.getDiv)(main_1.HtmlIDs.pasteIssuesDuplicates),this.submittedCallback=null,this.duplicates=null,this._cancelButton.addEventListener("click",()=>this._dialog.close()),this._submitButton.addEventListener("click",()=>this.onSubmitClick())}onSubmitClick(){var t;null!=this.duplicates&&null!=this.submittedCallback&&(t=this.duplicates.map(t=>{var e=(0,dom_utils_1.getSelect)(main_1.HtmlIDs.pasteIssuesDialogSelect(t.rowIndex)),e=t.options[parseInt(e.value)];return{rowIndex:t.rowIndex,option:e}}),this.submittedCallback(t),this._dialog.close())}show(t,e){this.duplicates=t,this.submittedCallback=e,this._duplicatesDiv.replaceChildren(),t.forEach(t=>{const e=document.createElement("h2"),s=(e.textContent=`Multiple rows found for "${t.stopName}"`,document.createElement("div")),i=(s.className="select-wrapper",document.createElement("div")),l=(i.className="select-highlight",document.createElement("div")),a=(l.className="select-arrow",document.createElement("select"));a.id=main_1.HtmlIDs.pasteIssuesDialogSelect(t.rowIndex),a.autocomplete="off",a.replaceChildren(...t.options.map((t,e)=>{var s=t.header.endsWith(" dep");return new Option(`Use "${t.header}"`,e.toString(),s,s)})),i.append(l),s.append(a,i),this._duplicatesDiv.append(e,s)}),this._dialog.showModal()}isOpen(){return 1==this._dialog.open}}},{"../dom-utils":29,"../main":35}],19:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.StatusScreens=void 0;const main_1=require("../main"),dom_utils_1=require("../dom-utils");exports.StatusScreens=class{constructor(){this._status=(0,dom_utils_1.getDiv)(main_1.HtmlIDs.status),this._statusLoading=(0,dom_utils_1.getDiv)(main_1.HtmlIDs.statusLoading),this._statusReady=(0,dom_utils_1.getDiv)(main_1.HtmlIDs.statusReady)}ready(){this._status.classList.remove("gone"),this._statusLoading.classList.add("gone"),this._statusReady.classList.remove("gone")}editing(){this._status.classList.add("gone")}}},{"../dom-utils":29,"../main":35}],20:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.createToast=void 0,exports.createToast=function(e){const t=document.getElementById("toasts"),o=document.createElement("div"),s=(o.className="toast",document.createElement("p"));s.textContent=e,o.append(s),t.append(o),setTimeout(()=>{o.remove()},1e4),document.querySelectorAll("#toasts .toast:not(:nth-last-child(-n + 5))").forEach(e=>e.remove())}},{}],21:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.exportTimetable=void 0;const timetable_validation_1=require("./timetable-validation");function kebabify(e){return e.toLowerCase().replace(/\s+/g,"-").replace(/[^0-9a-z-]/g,"_")}exports.exportTimetable=function(e,t){const n=(0,timetable_validation_1.validateTimetable)(e,t),i=t.line(e.lineID);if(n.some(e=>!e.isValid()))throw new Error("Some timetable sections are invalid");let o="";o+="[timetable]\nversion: 2\n"+`created: ${new Date(Date.now()).toISOString().split("T")[0]}
`+`id: ${e.timetableID.toFixed()}
`+`line: ${i.id.toFixed()}
`+"type: main\nbegins: *\nends: *\n";for(const a in e.sections){var r=e.sections[a],s=n[a];for(const e of[...new Set(s.directions)]){const n=i.directions.find(t=>t.id===e);if(null==n)throw new Error("Validation assumed some services ran in direction "+`"${e}" which is impossible for this line.`);o+=function(e,t,n,i){const o=e.stops.map(e=>e.toFixed().padStart(4,"0")+" "+kebabify(n.stopName(e))),a=Math.max(...o.map(e=>e.length)),r=o.map(e=>e.padEnd(a," "));let s=t.map((e,t)=>{t=i.nextDayThresholds[t];if(null==t)throw new Error("Validation failed to calculate next day thresholds for some services.");return{service:e,nextDayThreshold:t}});s=s.filter((t,n)=>i.directions[n]===e.id);for(const n of s)for(const i in e.stops){const o=e.stops[i],a=n.service.times[t.stops.indexOf(o)],s="-"===a||parseInt(i)<n.nextDayThreshold?a:">"+a;r[i]+=" "+s.padEnd(6," ")}return`
[${e.id}, ${t.wdr}]
${r.join("\n")}
`}(n,r,t,s)}}!function(e,t){const n=new Blob([e],{type:"text/plain"}),i=URL.createObjectURL(n),o=document.createElement("a");o.href=i,o.download=t,document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(i)}(o,`${e.timetableID.toString(36).padStart(2,"0")}-${kebabify(i.name)}.ttbl`)}},{"./timetable-validation":26}],22:[function(require,module,exports){"use strict";function getUpStopLists(t,e){const i=e.lines.find(e=>e.id===t);if(null==i)throw new Error("No line with id="+t);e=i.directions.map(t=>t.id);return function(t,e){if("linear"===t)return["up"];if("city-loop"===t)return["up-direct","up-via-loop"];if("branch"===t)return e.filter(t=>t.endsWith("-up"));throw new Error(`Route types of "${t}" are not supported.`)}(i.routeType,e).map(t=>{var e=i.directions.find(e=>e.id===t);if(null==e)throw new Error(`Expected an up direction called "${t}" on this line`);return[...e.stops]})}Object.defineProperty(exports,"__esModule",{value:!0}),exports.linearizeStopIDs=void 0,exports.linearizeStopIDs=function(t,e){const i=getUpStopLists(t,e);if(1==i.length)return i[0];let n=0;const o=[];for(;0<i.length;)if(0===i[n].length)i.splice(n,1),n=0;else{const t=i[n][0],e=i.findIndex((e,i)=>i!==n&&1<=e.indexOf(t));-1===e?(o.push(t),i.forEach(e=>{e[0]===t&&e.splice(0,1)})):(i[n].splice(0,1),n=e)}return function(t,e,i){const n=getUpStopLists(t,e);for(const t of n){let e=-1;for(const n of t){const t=i.indexOf(n);if(-1==t||t<=e)throw new Error('Cannot find linear order of stops to form the "up" and "down" directions');e=t}}}(t,e,o),o}},{}],23:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.loadNetwork=exports.Network=void 0;class Network{constructor(t){this._json=t}get lines(){if(null==this._json)throw new Error("Network not loaded.");return this._json.lines}stopName(t){if(null==this._json)throw new Error("Network not loaded.");var o=this._json.stops.find(o=>o.id===t);if(null==o)throw new Error("No stop with id="+t);return o.name}line(t){var o=this._json.lines.find(o=>o.id==t);if(null==o)throw new Error(`No train line with the ID "${t}"`);return o}directionsForLine(t){return this.line(t).directions}toJSON(){return{json:this._json}}static fromJSON(t){return new Network(t.json)}}exports.Network=Network,exports.loadNetwork=async function(t){const o=await fetch(`https://${t}/network/v1`);if(200!=o.status)throw new Error(`"${t}" did not respond.`);return t=await o.json(),new Network(t)}},{}],24:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.Service=exports.TimetableData=void 0;exports.TimetableData=class TimetableData{constructor(e=[]){this._services=e.map(e=>e.clone())}cell(e,s){return this._services[e].times[s]}service(e){return this._services[e].clone()}nextDay(e){return this._services[e].nextDay}map(e){return this._services.map((s,t)=>e(s.clone(),t))}filter(e){return this._services.map(e=>e.clone()).filter((s,t)=>e(s,t))}addServices(e,s){null==s?this._services.push(...e.map(e=>e.clone())):this._services.splice(s,0,...e.map(e=>e.clone()))}deleteServices(e,s){null==s?this._services.splice(e,1):this._services.splice(e,s-e)}replaceService(e,s){this._services[s]=e.clone()}replaceCell(e,s,t){this._services[e].times[s]=t}modifyCell(e,s,t){this._services[e].times[s]=t(this._services[e].times[s])}modifyCells(e,s,t,i,r){for(let c=Math.min(e,t);c<=Math.max(e,t);c++)for(let e=Math.min(s,i);e<=Math.max(s,i);e++)this._services[c].times[e]=r(this._services[c].times[e],c,e)}setNextDay(e,s){this._services[e].nextDay=s}clone(){return new TimetableData(this._services)}get width(){return this._services.length}toJSON(){return{services:this._services}}static fromJSON(e){return new TimetableData(e.services.map(e=>Service.fromJSON(e)))}};class Service{constructor(e,s){this.times=e,this.nextDay=s}clone(){return new Service([...this.times],this.nextDay)}static fromJSON(e){return new Service(e.times,e.nextDay)}}exports.Service=Service},{}],25:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.TimetableSection=void 0;const week_day_range_1=require("./week-day-range"),timetable_data_1=require("./timetable-data");exports.TimetableSection=class TimetableSection{constructor(t,e,a){this.generalDir=t,this.wdr=(0,week_day_range_1.validateWDR)(e),this.stops=a,this._data=new timetable_data_1.TimetableData,this.undoFrames=[],this.redoFrames=[],this.changed=null}edit(t,e){for(this.undoFrames.push({actionName:t,before:this._data});10<this.undoFrames.length;)this.undoFrames.shift();this.redoFrames=[],t=this._data.clone(),e(t),this._data=t,this.changed&&this.changed()}undo(){var t=this.undoFrames.pop();return null==t?null:(this.redoFrames.push({actionName:t.actionName,after:this._data}),this._data=t.before,this.changed&&this.changed(),t.actionName)}redo(){var t=this.redoFrames.pop();return null==t?null:(this.undoFrames.push({actionName:t.actionName,before:this._data}),this._data=t.after,this.changed&&this.changed(),t.actionName)}cell(t,e){return this._data.cell(t,e)}service(t){return this._data.service(t)}nextDay(t){return this._data.nextDay(t)}map(t){return this._data.map(t)}filter(t){return this._data.filter(t)}toJSON(){return{generalDir:this.generalDir,wdr:this.wdr,stops:this.stops,data:this._data.toJSON()}}static fromJSON(t){const e=new TimetableSection(t.generalDir,t.wdr,t.stops);return e._data=timetable_data_1.TimetableData.fromJSON(t.data),e}get width(){return this._data.width}get height(){return this.stops.length}}},{"./timetable-data":24,"./week-day-range":28}],26:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.ValidationResults=exports.validateSection=exports.validateTimetable=void 0;const utils_1=require("../utils");function validateSection(e,r,t){var s=new ValidationResults(e.width,e.height);return function(e,r){for(const t of(0,utils_1.range)(0,e.height))(0,utils_1.range)(0,e.width).some(r=>""==e.cell(r,t))&&r.reportStopError(t,"Stop has missing values")}(e,s),function(e,r){for(const t of(0,utils_1.range)(0,e.width)){const s=e.service(t);for(const i of(0,utils_1.range)(0,t)){const o=e.service(i);s.nextDay==o.nextDay&&s.times.every((e,r)=>e==o.times[r])&&r.reportServiceError(t,"Duplicated service")}}}(e,s),function(e,r,t,s){var i=r.line(t);for(const r of(0,utils_1.range)(0,e.width)){const t=e.service(r),o=/^((2[0-3]|[01][0-9]):[0-5][0-9]|-)$/;if(t.times.every(e=>""==e||o.test(e))){if(!t.times.some(e=>""==e)){const o=function(e,r,t){const s=e.filter((e,t)=>"-"!=r.times[t]);if(s.length<2)return null;const i=t.filter(e=>e.stops.filter(e=>s.includes(e)).every((e,r)=>s[r]===e));return 0==i.length?null:i.sort((e,r)=>e.stops.length-r.stops.length)[0].id}(e.stops,t,i.directions);if(null==o)s.reportServiceError(r,"Service direction unrecognized");else{s.reportServiceDirection(r,o,function(e,r){return"city-loop"===r.routeType?e.endsWith("-via-loop")?r.routeLoopPortal+"-via-loop":r.routeLoopPortal+"-direct":"branch"===r.routeType&&2==r.directions.length?e===r.directions[0].id?"branch-a":"branch-b":null}(o,i));const e=function(e){const r=[];let t=0;for(let s=0;s<e.times.length;s++){var i;"-"===e.times[s]?r.push(t):(i=(0,utils_1.parseMinuteOfDay)(e.times[s]),r.push(i),t=i)}const s=[];for(let e=1;e<r.length;e++)r[e-1]>r[e]&&s.push(e);return e.nextDay&&0===s.length?0:e.nextDay||0!==s.length?e.nextDay||1!==s.length?null:s[0]:r.length}(t);null==e?s.reportServiceError(r,"Time travel required (service spans too many days)"):s.reportNextDayThreshold(r,e)}}}else s.reportServiceError(r,"Cells contain invalid values")}}(e,r,t,s),s}exports.validateTimetable=function(e,r){return e.sections.map(t=>validateSection(t,r,e.lineID))},exports.validateSection=validateSection;class ValidationResults{constructor(e,r){this.stopErrors=(0,utils_1.repeat)(null,r),this.serviceErrors=(0,utils_1.repeat)(null,e),this.nextDayThresholds=(0,utils_1.repeat)(null,e),this.directions=(0,utils_1.repeat)(null,e),this.directionsIcons=(0,utils_1.repeat)(null,e)}reportStopError(e,r){this.stopErrors[e]=r}reportServiceError(e,r){this.serviceErrors[e]=r}reportServiceDirection(e,r,t){this.directions[e]=r,this.directionsIcons[e]=t}reportNextDayThreshold(e,r){this.nextDayThresholds[e]=r}isValid(){return this.stopErrors.every(e=>null==e)&&this.serviceErrors.every(e=>null==e)&&this.directions.every(e=>null!=e)}overallError(){let t=null;if(null==(t=null==(t=null==t?null!=(e=this.stopErrors.find(e=>null!=e))?e:null:t)?null!=(e=this.serviceErrors.find(e=>null!=e))?e:null:t))return null;var e=this.stopErrors.filter(e=>null!=e).length+this.serviceErrors.filter(e=>null!=e).length-1;return 0==e?t:1==e?t+" + 1 other error":t+` + ${e} other errors`}toJSON(){return{stopErrors:this.stopErrors,serviceErrors:this.serviceErrors,nextDayThresholds:this.nextDayThresholds,directionsIcons:this.directionsIcons}}static fromJSON(e){const r=new ValidationResults(e.serviceErrors.length,e.stopErrors.length);return r.stopErrors=e.stopErrors,r.serviceErrors=e.serviceErrors,r.nextDayThresholds=e.nextDayThresholds,r.directionsIcons=e.directionsIcons,r}}exports.ValidationResults=ValidationResults},{"../utils":36}],27:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.Timetable=void 0;const utils_1=require("../utils"),linearize_stops_1=require("./linearize-stops"),timetable_section_1=require("./timetable-section");exports.Timetable=class{constructor(e,t,i,s){this.timetableID=(0,utils_1.validateTimetableID)(e),this.lineID=(0,utils_1.validateLineID)(t,s),this._wdrs=i,this.sections=[];e=(0,linearize_stops_1.linearizeStopIDs)(t,s);this.linearizedStops={up:e,down:[...e].reverse()},i.forEach(e=>{this.sections.push(new timetable_section_1.TimetableSection("up",e,this.linearizedStops.up)),this.sections.push(new timetable_section_1.TimetableSection("down",e,this.linearizedStops.down))})}get generalDirs(){return["up","down"]}get wdrs(){return[...this._wdrs]}getTimetableSection(e,t){var i=this.sections.find(i=>i.generalDir===e&&i.wdr===t);if(null!=i)return i;throw new Error(`Timetable section in generalDir="${e}", `+`wdr="${t}" does not exist`)}getFirstSection(){return this.getTimetableSection(this.generalDirs[0],this.wdrs[0])}hasContent(){return this.sections.some(e=>0!=e.width)}}},{"../utils":36,"./linearize-stops":22,"./timetable-section":25}],28:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.validateWDR=exports.nameWDR=exports.WDRPresets=void 0,exports.WDRPresets=[["MTWT___","____F__","_____S_","______S"],["MTWTF__","_____S_","______S"],["MTWTFSS"],["M______","_TWT___","____F__","_____S_","______S"],["M______","_TWTF__","_____S_","______S"],["M______","_T_____","__W____","___T___","____F__","_____S_","______S"]];const WDRNames={M______:"Mon",_T_____:"Tue",__W____:"Wed",___T___:"Thu",____F__:"Fri",_____S_:"Sat",______S:"Sun",MTWT___:"Mon-Thu",MTWTF__:"Mon-Fri",MTWTFSS:"Mon-Sun",_TWT___:"Tue-Thu",_TWTF__:"Tue-Fri"};exports.nameWDR=function(_){if(_ in WDRNames)return WDRNames[_];throw new Error(`Week day range value "${_}" is invalid or not supported`)},exports.validateWDR=function(_){if(/^(M|_)(T|_)(W|_)(T|_)(F|_)(S|_)(S|_)$/.test(_))return _;throw new Error(`Invalid week day range value: "${_}"`)}},{}],29:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.getHtmlOther=exports.getCanvas=exports.getParagraph=exports.getInput=exports.getSelect=exports.getDiv=exports.getButton=void 0,exports.getButton=function(t){var e=document.getElementById(t);if(e instanceof HTMLButtonElement)return e;throw new Error(`"#${t}" is not a HTMLButtonElement in the DOM.`)},exports.getDiv=function(t){var e=document.getElementById(t);if(e instanceof HTMLDivElement)return e;throw new Error(`"#${t}" is not a HTMLDivElement in the DOM.`)},exports.getSelect=function(t){var e=document.getElementById(t);if(e instanceof HTMLSelectElement)return e;throw new Error(`"#${t}" is not a HTMLSelectElement in the DOM.`)},exports.getInput=function(t){var e=document.getElementById(t);if(e instanceof HTMLInputElement)return e;throw new Error(`"#${t}" is not a HTMLInputElement in the DOM`)},exports.getParagraph=function(t){var e=document.getElementById(t);if(e instanceof HTMLParagraphElement)return e;throw new Error(`"#${t}" is not a HTMLParagraphElement in the DOM`)},exports.getCanvas=function(t){var e=document.getElementById(t);if(e instanceof HTMLCanvasElement)return e;throw new Error(`"#${t}" is not a HTMLCanvasElement in the DOM`)},exports.getHtmlOther=function(t){var e=document.getElementById(t);if(null!=e)return e;throw new Error(`"#${t}" is not in the DOM.`)}},{}],30:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.css=void 0,exports.css={text:"hsla(220deg, 100%, 4%, 0.8)",paper10:"hsl(220deg, 30%, 93.5%)",accent:"#00a5ca",hoverHighlight:"hsla(220deg, 100%, 18%, 0.1)"}},{}],31:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.EditorGrid=exports.editorColSize=exports.editorRowSize=void 0;const editor_grid_css_1=require("./editor-grid-css"),dom_utils_1=require("../dom-utils"),main_1=require("../main");exports.editorRowSize=20,exports.editorColSize=48;exports.EditorGrid=class{constructor(t){this._editor=t,this._grid=(0,dom_utils_1.getDiv)(main_1.HtmlIDs.editorGrid),this._canvas=(0,dom_utils_1.getCanvas)(main_1.HtmlIDs.editorGridCanvas);t=this._canvas.getContext("2d");if(null==t)throw new Error("This browser doesn't seem to support 2d canvas.");this._context=t,this._selected=null,this._dragging=!1,this._mouseOver=null,this._nextDayThresholds=[],this._canvas.addEventListener("mousedown",t=>{t=this.relativeCoords(t);this._selected={startX:t.x,startY:t.y,endX:t.x,endY:t.y},this._dragging=!0,this.draw()}),this._canvas.addEventListener("mouseup",t=>{this._dragging=!1,null!=this._selected&&(t=this.relativeCoords(t),this._selected.endX=t.x,this._selected.endY=t.y),this.draw()}),this._canvas.addEventListener("mousemove",t=>this.onMouseMove(t)),this._canvas.addEventListener("mouseenter",t=>this.onMouseMove(t)),this._canvas.addEventListener("mouseleave",()=>{this._mouseOver=null,this.draw()})}resetEvents(){this._selected=null,this._dragging=!1,this.resetMouseOver()}resetMouseOver(){this._mouseOver=null}draw(){var t,e,s;const i=this._editor.section,o=null!=(t=null==i?void 0:i.width)?t:0,r=null!=(e=null==i?void 0:i.height)?e:0,d=this.calculateDpiRatio(),l=this.getOnScreenCells(r,o);if(this._grid.style.width=exports.editorColSize*o+"px",this._grid.style.height=exports.editorRowSize*r+"px",this._canvas.width=exports.editorColSize*l.width*d,this._canvas.height=exports.editorRowSize*l.height*d,this._canvas.style.width=exports.editorColSize*l.width+"px",this._canvas.style.height=exports.editorRowSize*l.height+"px",this._canvas.style.left=exports.editorColSize*l.x1+"px",this._canvas.style.top=exports.editorRowSize*l.y1+"px",this._context.clearRect(0,0,this._canvas.width,this._canvas.height),this._context.translate(-l.x1*exports.editorColSize*d,-l.y1*exports.editorRowSize*d),this._context.scale(d,d),null!=i){this._context.fillStyle=editor_grid_css_1.css.paper10;for(let t=l.y1;t<l.y2;t++)t%2==0&&this._context.fillRect(l.x1*exports.editorColSize,t*exports.editorRowSize,l.width*exports.editorColSize,exports.editorRowSize);this._context.font="0.7rem 'Roboto Mono', monospace";for(let t=l.x1;t<l.x2;t++){const e=null!=(s=this._nextDayThresholds[t])?s:i.height;for(let s=l.y1;s<l.y2;s++){this._context.fillStyle=s<e?editor_grid_css_1.css.text:editor_grid_css_1.css.accent;const o=i.cell(t,s),r=this._context.measureText(o).width;this._context.fillText(o,t*exports.editorColSize+(exports.editorColSize-r)/2,s*exports.editorRowSize+14)}}if(this._context.fillStyle=editor_grid_css_1.css.hoverHighlight,null!=this._mouseOver&&this._context.fillRect(this._mouseOver.x*exports.editorColSize,this._mouseOver.y*exports.editorRowSize,exports.editorColSize,exports.editorRowSize),this._context.lineWidth=Math.round(1.5*d)/d,this._context.strokeStyle=editor_grid_css_1.css.accent,null!=this._selected){const t=Math.min(this._selected.startX,this._selected.endX),e=Math.max(this._selected.startX,this._selected.endX)-t+1,s=Math.min(this._selected.startY,this._selected.endY),i=Math.max(this._selected.startY,this._selected.endY)-s+1;this._context.strokeRect(t*exports.editorColSize,s*exports.editorRowSize,e*exports.editorColSize,i*exports.editorRowSize)}}}relativeCoords(t){var e=this._grid.getBoundingClientRect(),s=t.clientX-e.left,t=t.clientY-e.top;return{x:Math.floor(s/exports.editorColSize),y:Math.floor(t/exports.editorRowSize)}}onMouseMove(t){this._mouseOver=this.relativeCoords(t),this._dragging&&(1!=t.buttons?this._dragging=!1:null!=this._selected&&(this._selected.endX=this._mouseOver.x,this._selected.endY=this._mouseOver.y)),this.draw()}calculateDpiRatio(){return(window.devicePixelRatio||1)/(this._context.backingStorePixelRatio||1)}getOnScreenCells(t,e){var s=this._editor.clientSize(),i=this._editor.scrollPos(),o=s.width-this._editor.stops.clientWidth(),s=s.height-this._editor.services.clientHeight(),d=Math.max(0,Math.floor(i.y/exports.editorRowSize)),t=Math.min(t,d+Math.ceil(s/exports.editorRowSize)+1),s=t-d,i=Math.max(0,Math.floor(i.x/exports.editorColSize)),e=Math.min(e,i+Math.ceil(o/exports.editorColSize)+1);return{x1:i,x2:e,y1:d,y2:t,width:e-i,height:s}}get selected(){return null==this._selected?null:Object.assign({},this._selected)}get selectedRange(){return null==this._selected?null:{x1:Math.min(this._selected.startX,this._selected.endX),y1:Math.min(this._selected.startY,this._selected.endY),x2:Math.max(this._selected.startX,this._selected.endX),y2:Math.max(this._selected.startY,this._selected.endY)}}select(t,e,s,i){this._selected={startX:t,startY:e,endX:null!=s?s:t,endY:null!=i?i:e},this.draw()}clearSelection(){this._selected=null,this.draw()}setNextDayThresholds(t){this._nextDayThresholds=t,this.draw()}}},{"../dom-utils":29,"../main":35,"./editor-grid-css":30}],32:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.EditorServices=void 0;const dom_utils_1=require("../dom-utils"),main_1=require("../main");exports.EditorServices=class{constructor(){this._servicesDiv=(0,dom_utils_1.getDiv)(main_1.HtmlIDs.editorServices),this._currNextDay=[],this.serviceClicked=null}clear(){this.setServices([])}setServices(e){e.length==this._currNextDay.length&&e.every((e,i)=>this._currNextDay[i]==e)||(this._currNextDay=e,this._servicesDiv.replaceChildren(...e.map(e=>this.makeButton(e))))}markErrorServices(e){this._servicesDiv.querySelectorAll(".service").forEach((i,r)=>{e[r]?i.classList.add("error"):i.classList.remove("error")})}markServiceDirectionIcons(e){this._servicesDiv.querySelectorAll(".service .direction-icon").forEach((i,r)=>{const t=i;null==e[r]?t.classList.add("gone"):(t.src=`service-icons/${e[r]}.svg`,t.classList.remove("gone"))})}makeButton(e){const i=document.createElement("button"),r=(i.className="service",document.createElement("img"));if(r.className="direction-icon gone",r.alt="Service direction indicator",i.append(r),e){const e=document.createElement("img");e.src="service-icons/next-day.svg",e.alt="Next day",i.append(e)}return i.addEventListener("click",()=>{if(null!=this.serviceClicked){var e=i.parentElement;if(null==e)throw new Error("Clicked service button had no parent");e=Array.from(e.children).indexOf(i);this.serviceClicked(e)}}),i}clientHeight(){return this._servicesDiv.getBoundingClientRect().height}}},{"../dom-utils":29,"../main":35}],33:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.EditorStops=void 0;const dom_utils_1=require("../dom-utils"),main_1=require("../main");exports.EditorStops=class{constructor(){this._stopsDiv=(0,dom_utils_1.getDiv)(main_1.HtmlIDs.editorStops),this.stopClicked=null}clear(){this.setStops([])}setStops(t){this._stopsDiv.replaceChildren(...t.map((t,e)=>{const s=document.createElement("button"),o=(s.className="stop",document.createElement("p"));return o.textContent=t,s.append(o),s.addEventListener("click",()=>{null!=this.stopClicked&&this.stopClicked(e)}),s}))}markErrorStops(t){this._stopsDiv.querySelectorAll(".stop").forEach((e,s)=>{t[s]?e.classList.add("error"):e.classList.remove("error")})}clientWidth(){return this._stopsDiv.getBoundingClientRect().width}}},{"../dom-utils":29,"../main":35}],34:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.Editor=void 0;const dom_utils_1=require("../dom-utils"),main_1=require("../main"),utils_1=require("../utils"),editor_grid_1=require("./editor-grid"),editor_services_1=require("./editor-services"),editor_stops_1=require("./editor-stops");exports.Editor=class{constructor(i){this.section=null,this.grid=new editor_grid_1.EditorGrid(this),this.stops=new editor_stops_1.EditorStops,this.services=new editor_services_1.EditorServices,this._editorDiv=(0,dom_utils_1.getHtmlOther)(main_1.HtmlIDs.editor),this._validationTimeoutID=null,this._validationRequestCallback=i,this._editorDiv.addEventListener("scroll",()=>{this.grid.resetMouseOver(),this.grid.draw()});i=i=>this.onScrollWheel(i);this._editorDiv.addEventListener("mousewheel",i,!1),this._editorDiv.addEventListener("DOMMouseScroll",i,!1),this.stops.stopClicked=i=>this.onStopClicked(i),this.services.serviceClicked=i=>this.onServiceClicked(i),this.grid.draw()}resize(){this.grid.resetMouseOver(),this.grid.draw()}clear(){null!=this.section&&(this.section.changed=null),this.section=null,this.stops.clear(),this.services.clear(),this.grid.resetEvents(),this.grid.setNextDayThresholds([]),this.grid.draw()}setSection(i,t){null!=this.section&&(this.section.changed=null),this.section=i,this.stops.setStops(i.stops.map(i=>t.stopName(i))),this.services.setServices(this.section.map(i=>i.nextDay)),this.section.changed=()=>this.onChanged(),this.grid.resetEvents(),this.grid.draw(),this._validationRequestCallback(i)}applyValidationOverlay(i){const t=this.section;null!=t&&(this.stops.markErrorStops(i.stopErrors.map(i=>null!=i)),this.services.markErrorServices(i.serviceErrors.map(i=>null!=i)),this.services.markServiceDirectionIcons(i.directionsIcons),this.grid.setNextDayThresholds(i.nextDayThresholds.map(i=>null==i?t.height:i)))}onChanged(){null!=this.section&&(this.grid.draw(),this.services.setServices(this.section.map(i=>i.nextDay)),null!=this._validationTimeoutID&&(clearTimeout(this._validationTimeoutID),this._validationTimeoutID=null),this._validationTimeoutID=setTimeout(()=>{null!=this.section&&this._validationRequestCallback(this.section)},500))}onServiceClicked(i){null!=this.section&&this.grid.select(i,0,i,this.section.height-1)}onStopClicked(i){null!=this.section&&0!=this.section.width&&this.grid.select(0,i,this.section.width-1,i)}onScrollWheel(i){var t=i=window.event||i,t=(0,utils_1.clamp)(t.wheelDelta||-t.detail,-1,1);this._editorDiv.scrollLeft-=64*t,i.preventDefault()}clientSize(){return this._editorDiv.getBoundingClientRect()}scrollPos(){return{x:this._editorDiv.scrollLeft,y:this._editorDiv.scrollTop}}}},{"../dom-utils":29,"../main":35,"../utils":36,"./editor-grid":31,"./editor-services":32,"./editor-stops":33}],35:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.HtmlIDs=exports.validationWorkerScriptName=exports.apiDomain=void 0;const network_1=require("./data/network"),command_listener_1=require("./commands/command-listener"),app_context_1=require("./app-context"),status_screens_1=require("./components/status-screens");exports.apiDomain="api.trainquery.com",exports.validationWorkerScriptName="validation-worker.js";class HtmlIDs{static pasteIssuesDialogSelect(e){return"paste-issues-dialog-duplicate-"+e}}(exports.HtmlIDs=HtmlIDs).editor="editor",HtmlIDs.editorGrid="grid",HtmlIDs.editorGridCanvas="grid-canvas",HtmlIDs.editorStops="stops",HtmlIDs.editorServices="services",HtmlIDs.headerNewTimetableButton="new-timetable-button",HtmlIDs.headerImportButton="import-button",HtmlIDs.headerExportButton="export-button",HtmlIDs.headerTabs="tabs",HtmlIDs.status="status",HtmlIDs.statusLoading="status-loading",HtmlIDs.statusReady="status-ready",HtmlIDs.newTimetableDialog="new-timetable-dialog",HtmlIDs.newTimetableCancelButton="new-timetable-dialog-cancel",HtmlIDs.newTimetableSubmitButton="new-timetable-dialog-submit",HtmlIDs.newTimetableLinesSelect="new-timetable-dialog-lines",HtmlIDs.newTimetableWDRsSelect="new-timetable-dialog-wdrs",HtmlIDs.newTimetableIdInput="new-timetable-dialog-id",HtmlIDs.newTimetableErrorText="new-timetable-dialog-error",HtmlIDs.pasteIssuesDialog="paste-issues-dialog",HtmlIDs.pasteIssuesCancelButton="paste-issues-dialog-cancel",HtmlIDs.pasteIssuesSubmitButton="paste-issues-dialog-submit",HtmlIDs.pasteIssuesDuplicates="paste-issues-dialog-duplicates",HtmlIDs.footerError="footer-error";const status=new status_screens_1.StatusScreens;(0,network_1.loadNetwork)(exports.apiDomain).then(e=>{const t=new app_context_1.AppContext(e,status),s=new command_listener_1.CommandListener(t);document.addEventListener("keydown",e=>s.onDocKeyEvent(e)),document.addEventListener("paste",e=>s.onPaste(e)),window.addEventListener("resize",()=>t.editor.resize()),window.onbeforeunload=()=>{if(null!=t.timetable&&t.timetable.hasContent())return!0}})},{"./app-context":1,"./commands/command-listener":4,"./components/status-screens":19,"./data/network":23}],36:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.getErrorMessage=exports.standardizeTimeString=exports.parseMinuteOfDay=exports.repeat=exports.range=exports.clamp=exports.validateLineID=exports.validateTimetableID=void 0,exports.validateTimetableID=function(e){if(isNaN(e))throw new Error("No timetable ID given");if(1295<e||e<0)throw new Error("Timetable ID must be 0-1295 to fit within two base-36 "+`digits (given ${e})`);return e},exports.validateLineID=function(e,t){if(t.lines.some(t=>t.id===e))return e;throw new Error("There is no line with id="+e)},exports.clamp=function(e,t,r){var a=Math.min(t,r),t=Math.max(t,r);return Math.min(Math.max(e,a),t)},exports.range=function(e,t){return[...Array(t-e).keys()].map(t=>t+e)},exports.repeat=function(e,t){const r=[];for(let a=0;a<t;a++)r.push(e);return r},exports.parseMinuteOfDay=function(e){var t=e.split(":"),r=parseInt(t[0]),t=parseInt(t[1]);if(isNaN(r)||isNaN(t)||r<0||t<0||23<r||59<t)throw new Error(`"${e}" is not a valid time of day`);return 60*r+t},exports.standardizeTimeString=function(e){if(!/^[0-9]{1,2}:[0-9]{2}(am|pm)?$/g.test(e))return null;const t=e.split(":");let r=parseInt(t[0]);const a=parseInt(t[1].replace("am","").replace("pm",""));return(e.endsWith("am")||e.endsWith("pm"))&&(r%=12,e.endsWith("pm")&&(r+=12)),r<0||24<=r||a<0||60<=a?null:r.toFixed().padStart(2,"0")+":"+a.toFixed().padStart(2,"0")},exports.getErrorMessage=function(e){return e instanceof Error?e.message:"Something went wrong"}},{}],37:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.Validator=void 0;const timetable_validation_1=require("./data/timetable-validation"),main_1=require("./main");exports.Validator=class{constructor(t,e){this._worker=new Worker(main_1.validationWorkerScriptName),this.resultsCallback=e,this._worker.postMessage({network:t.toJSON()}),this._worker.onmessage=t=>{this.resultsCallback(timetable_validation_1.ValidationResults.fromJSON(t.data))}}requestValidation(t,e){this._worker.postMessage({section:t.toJSON(),lineID:e})}}},{"./data/timetable-validation":26,"./main":35}]},{},[35]);
