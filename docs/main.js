!function r(e,n,t){function o(i,f){if(!n[i]){if(!e[i]){var c="function"==typeof require&&require;if(!f&&c)return c(i,!0);if(u)return u(i,!0);throw(f=new Error("Cannot find module '"+i+"'")).code="MODULE_NOT_FOUND",f}c=n[i]={exports:{}},e[i][0].call(c.exports,function(r){return o(e[i][1][r]||r)},c,c.exports,r,e,n,t)}return n[i].exports}for(var u="function"==typeof require&&require,i=0;i<t.length;i++)o(t[i]);return o}({1:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.AltArrowsHandler=void 0;const utils_1=require("../utils"),command_handler_1=require("./command-handler");class AltArrowsHandler extends command_handler_1.CommandHandler{constructor(){super([(0,command_handler_1.keyFilter)({key:"ArrowLeft",alt:!0}),(0,command_handler_1.keyFilter)({key:"ArrowRight",alt:!0})])}handle(e,r,t,i,s,c){const l=c.editor.section,o=c.editor.grid;if(null!=l&&0!=l.width&&null!=o.selected){const{x1:n,y1:d,x2:a,y2:h}=o.selectedRange;if(0==d&&h==l.height-1){if("ArrowLeft"==r&&0<n){const e=n==a?"Shift service left":"Shift services left";l.edit(e,e=>{const r=e.service(n-1);for(const r of(0,utils_1.range)(n,a+1))e.replaceService(e.service(r),r-1);e.replaceService(r,a)}),o.select(n-1,0,a-1,l.height-1)}if("ArrowRight"==r&&a<l.width-1){const e=n==a?"Shift service right":"Shift services right";l.edit(e,e=>{const r=e.service(a+1);for(const r of(0,utils_1.range)(n,a+1))e.replaceService(e.service(r),r+1);e.replaceService(r,n)}),o.select(n+1,0,a+1,l.height-1)}}}}}exports.AltArrowsHandler=AltArrowsHandler},{"../utils":35,"./command-handler":2}],2:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.CommandHandler=exports.keyFilter=void 0,exports.keyFilter=function(e){var l;return{char:e.char,key:e.key,ctrl:"*"==e.ctrl?null:null!=(l=e.ctrl)&&l,alt:"*"==e.alt?null:null!=(l=e.alt)&&l,shift:"*"==e.shift?null:null!=(l=e.shift)&&l}};exports.CommandHandler=class{constructor(e){this.acceptedFilters=e}}},{}],3:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.CommandListener=void 0;const select_arrows_handler_1=require("./select-arrows-handler"),tab_handler_1=require("./tab-handler"),extract_content_1=require("./extract-content"),toast_1=require("../components/toast"),enter_handler_1=require("./enter-handler"),delete_handler_1=require("./delete-handler"),select_all_handler_1=require("./select-all-handler"),undo_handler_1=require("./undo-handler"),alt_arrows_handler_1=require("./alt-arrows-handler"),text_entry_handler_1=require("./text-entry-handler"),new_service_handler_1=require("./new-service-handler"),space_handler_1=require("./space-handler"),next_day_handler_1=require("./next-day-handler"),timetable_data_1=require("../data/timetable-data");exports.CommandListener=class{constructor(){this._handlers=[new select_arrows_handler_1.SelectArrowsHandler,new tab_handler_1.TabHandler,new enter_handler_1.EnterHandler,new delete_handler_1.DeleteHandler,new select_all_handler_1.SelectAllHandler,new undo_handler_1.UndoHandler,new alt_arrows_handler_1.AltArrowsHandler,new text_entry_handler_1.TextEntryHandler,new new_service_handler_1.NewServiceHandler,new space_handler_1.SpaceHandler,new next_day_handler_1.NextDayHandler]}init(e){this._appContext=e}onKey(e,t,n,a,r){const l=this._handlers.find(l=>l.acceptedFilters.some(l=>!(null!=l.char&&l.char!=e||null!=l.key&&l.key!=t||null!=l.ctrl&&l.ctrl!=n||null!=l.alt&&l.alt!=a||null!=l.shift&&l.shift!=r&&null==l.char)));return null!=l&&(l.handle(e,t,n,a,r,this._appContext),!0)}onDocKeyEvent(e){this._appContext.newTimetableDialog.isOpen()||this._appContext.pasteIssuesDialog.isOpen()||"Control"!=e.key&&"Meta"!=e.key&&"Alt"!=e.key&&"Shift"!=e.key&&!this.onKey(e.key,e.code,e.ctrlKey||e.metaKey,e.altKey,e.shiftKey)||e.preventDefault()}onPaste(e){const t=this._appContext.editor.section,n=this._appContext.newTimetableDialog,a=this._appContext.pasteIssuesDialog,r=this._appContext.network;if(null!=t&&!n.isOpen()&&!a.isOpen()){var l=e.clipboardData.getData("text");e.preventDefault();const s=t.stops.map(e=>r.stopName(e));(0,extract_content_1.extractContent)(l,s,a,(e,n)=>{s.length-n.length<=1?(0,toast_1.createToast)("That didn't seem like timetable content."):(t.edit("Paste timetable content",t=>{t.addServices(e.map(e=>new timetable_data_1.Service(e,!1)))}),3<n.length?(0,toast_1.createToast)(n.length+" stops were missing from the pasted content."):0!=n.length&&(0,toast_1.createToast)(`${n.join(", ")} ${1==n.length?"was":"were"} `+"missing from the pasted content."))})}}}},{"../components/toast":19,"../data/timetable-data":25,"./alt-arrows-handler":1,"./delete-handler":4,"./enter-handler":5,"./extract-content":6,"./new-service-handler":7,"./next-day-handler":8,"./select-all-handler":9,"./select-arrows-handler":10,"./space-handler":11,"./tab-handler":12,"./text-entry-handler":13,"./undo-handler":14}],4:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.DeleteHandler=void 0;const command_handler_1=require("./command-handler");class DeleteHandler extends command_handler_1.CommandHandler{constructor(){super([(0,command_handler_1.keyFilter)({key:"Delete",ctrl:"*"})])}handle(e,t,l,r,d,n){const s=n.editor.section,a=n.editor.grid;if(null!=s&&null!=a.selected){const{startX:c,startY:o,endX:i,endY:m}=a.selected;if(0!=o||m!=s.height-1||l)s.edit("Delete text",e=>{e.modifyCells(c,o,i,m,()=>"")});else{const e=c==i?"Delete service":"Delete services";s.edit(e,e=>{e.deleteServices(Math.min(c,i),Math.max(c,i)+1)}),a.clearSelection()}}}}exports.DeleteHandler=DeleteHandler},{"./command-handler":2}],5:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.EnterHandler=void 0;const command_handler_1=require("./command-handler");class EnterHandler extends command_handler_1.CommandHandler{constructor(){super([(0,command_handler_1.keyFilter)({key:"Enter"})])}handle(e,r,n,t,d,l){const s=l.editor.section,o=l.editor.grid;if(null!=s&&null!=o.selected){const{startX:a,startY:c,endX:i,endY:m}=o.selected;s.edit("Fill empty cells",e=>{e.modifyCells(a,c,i,m,e=>""===e?"-":e)})}}}exports.EnterHandler=EnterHandler},{"./command-handler":2}],6:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.extractContent=void 0;const utils_1=require("../utils"),timetableRowRegex=/^.+( +(([0-9]{1,2}[:.][0-9]{2}(am|pm|[uda])?)|-))+$/,timesOnlyRegex=/( +(([0-9]{1,2}[:.][0-9]{2}(am|pm|[uda])?)|-))+$/;exports.extractContent=function(t,e,n,o){!function(t,e,n,o){const r=[],s=[],i={};for(let n=0;n<e.length;n++){const o=e[n],l=t.filter(t=>t.stop===o);1==l.length?i[n]=l[0].times:0==l.length?(i[n]=null,r.push(o)):(i[n]=null,s.push({stopName:o,rowIndex:n,options:l}))}0<s.length?n.show(s,t=>{for(const e of t)i[e.rowIndex]=e.option.times;o(i,r)}):o(i,r)}(function(t,e){return(t=t.toLowerCase().replace(/[-–—]/g,"-")).split("\n").map(t=>t.replace(/\s+/g," ").trim()).filter(t=>timetableRowRegex.test(t)).map(t=>{const n=t.split(timesOnlyRegex)[0];return{stop:e.find(t=>function(t,e){return(t=t.toLowerCase().trim())===(e=e.toLowerCase())||t.startsWith(e)&&/^ (dep|arr|station|stn\.?|\([0-9]+\))$/g.test(t.substring(e.length))}(n,t)),times:t.substring(timesOnlyRegex.exec(t).index).trim().split(" "),header:n}}).filter(t=>null!=t.stop)}(t,e),e,n,(t,e)=>{t=function(t){const e=Math.max(...Object.keys(t).map(e=>t[parseInt(e)]).filter(t=>null!=t).map(t=>t.length)),n=Object.keys(t).length,o=[];for(let r=0;r<n;r++)for(let n=0;n<e;n++)null==o[n]&&(o[n]=[]),null==t[r]||t[r].length<=n?o[n][r]="":o[n][r]=function(t){return"-"===t?"-":(t=t.replace(".",":").replace(/[ uda]\b/,""),null!=(t=(0,utils_1.standardizeTimeString)(t))?t:"?")}(t[r][n]);return o}(t);o(t,e)})}},{"../utils":35}],7:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.NewServiceHandler=void 0;const timetable_data_1=require("../data/timetable-data"),utils_1=require("../utils"),command_handler_1=require("./command-handler");class NewServiceHandler extends command_handler_1.CommandHandler{constructor(){super([(0,command_handler_1.keyFilter)({key:"KeyN",shift:!0})])}handle(e,r,t,a,d,i){const n=i.editor.section;null!=n&&n.edit("Add empty service",e=>{e.addServices([new timetable_data_1.Service((0,utils_1.repeat)("",n.height),!1)])})}}exports.NewServiceHandler=NewServiceHandler},{"../data/timetable-data":25,"../utils":35,"./command-handler":2}],8:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.NextDayHandler=void 0;const utils_1=require("../utils"),command_handler_1=require("./command-handler");class NextDayHandler extends command_handler_1.CommandHandler{constructor(){super([(0,command_handler_1.keyFilter)({key:"KeyM",shift:!0})])}handle(e,t,r,n,a,d){const s=d.editor.section,l=d.editor.grid;if(null!=s&&null!=l.selected){const{startX:o,startY:i,endX:c,endY:u}=l.selected;if(0==i&&u==s.height-1){const x=s.nextDay(o);s.edit("Toggle next day",e=>{(0,utils_1.range)(o,c+1).forEach(t=>e.setNextDay(t,!x))})}}}}exports.NextDayHandler=NextDayHandler},{"../utils":35,"./command-handler":2}],9:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.SelectAllHandler=void 0;const command_handler_1=require("./command-handler");class SelectAllHandler extends command_handler_1.CommandHandler{constructor(){super([(0,command_handler_1.keyFilter)({key:"KeyA",ctrl:!0})])}handle(e,l,r,t,d,n){const c=n.editor.section,o=n.editor.grid;null!=c&&0!=c.width&&o.select(0,0,c.width-1,c.height-1)}}exports.SelectAllHandler=SelectAllHandler},{"./command-handler":2}],10:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.SelectArrowsHandler=void 0;const utils_1=require("../utils"),command_handler_1=require("./command-handler");class SelectArrowsHandler extends command_handler_1.CommandHandler{constructor(){super([(0,command_handler_1.keyFilter)({key:"ArrowUp",ctrl:"*",shift:"*"}),(0,command_handler_1.keyFilter)({key:"ArrowDown",ctrl:"*",shift:"*"}),(0,command_handler_1.keyFilter)({key:"ArrowLeft",ctrl:"*",shift:"*"}),(0,command_handler_1.keyFilter)({key:"ArrowRight",ctrl:"*",shift:"*"})])}handle(e,r,t,o,l,s){const d=s.editor.section,n=s.editor.grid;if(null!=d&&0!=d.width&&null!=n.selected){let c=0,i="ArrowDown"==r?1:"ArrowUp"==r?-1:0;"ArrowLeft"==r&&(c=-1),"ArrowRight"==r&&(c=1);var{startX:s,startY:r,endX:m,endY:w}=n.selected;if(l){const e=this.coordsFromOffset(d,m,w,c,i,t);void n.select(s,r,e.x,e.y)}else{l=this.coordsFromOffset(d,s,r,c,i,t);n.select(l.x,l.y,l.x,l.y)}}}coordsFromOffset(e,r,t,o,l,s){return s&&(o*=e.width,l*=e.height),{x:(0,utils_1.clamp)(r+o,0,e.width-1),y:(0,utils_1.clamp)(t+l,0,e.height-1)}}}exports.SelectArrowsHandler=SelectArrowsHandler},{"../utils":35,"./command-handler":2}],11:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.SpaceHandler=void 0;const utils_1=require("../utils"),command_handler_1=require("./command-handler");class SpaceHandler extends command_handler_1.CommandHandler{constructor(){super([(0,command_handler_1.keyFilter)({key:"Space"})])}handle(e,l,r,t,a,n){const d=n.editor.section,c=n.editor.grid;if(null!=d&&0!=d.width&&null!=c.selected){const{x1:s,y1:i,y2:o}=c.selectedRange;(0,utils_1.range)(i,o+1).every(e=>""!=d.cell(s,e)&&(0,utils_1.range)(s+1,d.width).some(l=>""==d.cell(l,e)))&&(d.edit("Fill timetable gap",e=>{(0,utils_1.range)(i,o+1).forEach(l=>{for(let r=d.map(e=>e.times[l]).findIndex(e=>""==e);r>=s;r--)r==s?e.replaceCell(r,l,"-"):e.replaceCell(r,l,d.cell(r-1,l))})}),c.select(s+1,i,s+1,o))}}}exports.SpaceHandler=SpaceHandler},{"../utils":35,"./command-handler":2}],12:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.TabHandler=void 0;const command_handler_1=require("./command-handler");class TabHandler extends command_handler_1.CommandHandler{constructor(){super([(0,command_handler_1.keyFilter)({key:"Tab",shift:"*"})])}handle(e,t,s,l,d,i){var o,n,c,a,h=i.editor.section,i=i.editor.grid;null!=h&&0!=h.width&&(null==i.selected?d?this.selectCol(i,h,h.width-1):this.selectCol(i,h,0):({startX:o,startY:n,endX:c,endY:a}=i.selected,0!=n||a!=h.height-1?0!=o||c!=h.width-1?this.selectCol(i,h,o):d?this.selectRow(i,h,(n-1+h.height)%h.height):this.selectRow(i,h,(n+1)%h.height):d?this.selectCol(i,h,(o-1+h.width)%h.width):this.selectCol(i,h,(o+1)%h.width)))}selectCol(e,t,s){e.select(s,0,s,t.height-1)}selectRow(e,t,s){e.select(0,s,t.width-1,s)}}exports.TabHandler=TabHandler},{"./command-handler":2}],13:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.TextEntryHandler=void 0;const command_handler_1=require("./command-handler");class TextEntryHandler extends command_handler_1.CommandHandler{constructor(){super([(0,command_handler_1.keyFilter)({char:"0"}),(0,command_handler_1.keyFilter)({char:"1"}),(0,command_handler_1.keyFilter)({char:"2"}),(0,command_handler_1.keyFilter)({char:"3"}),(0,command_handler_1.keyFilter)({char:"4"}),(0,command_handler_1.keyFilter)({char:"5"}),(0,command_handler_1.keyFilter)({char:"6"}),(0,command_handler_1.keyFilter)({char:"7"}),(0,command_handler_1.keyFilter)({char:"8"}),(0,command_handler_1.keyFilter)({char:"9"}),(0,command_handler_1.keyFilter)({char:"-"}),(0,command_handler_1.keyFilter)({char:":"}),(0,command_handler_1.keyFilter)({key:"Backspace"})])}handle(e,r,a,n,d,l){const t=l.editor.section,c=l.editor.grid;if(null!=t&&null!=c.selected){const{startX:m,startY:o,endX:h,endY:_}=c.selected;m==h&&o==_||c.select(m,o),t.edit("Edit cell",a=>{"Backspace"==r?a.modifyCell(m,o,e=>0==e.length?e:e.substring(0,e.length-1)):a.modifyCell(m,o,r=>5<=r.length?r:r+e)})}}}exports.TextEntryHandler=TextEntryHandler},{"./command-handler":2}],14:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.UndoHandler=void 0;const toast_1=require("../components/toast"),command_handler_1=require("./command-handler");class UndoHandler extends command_handler_1.CommandHandler{constructor(){super([(0,command_handler_1.keyFilter)({key:"KeyZ",ctrl:!0,shift:"*"}),(0,command_handler_1.keyFilter)({key:"KeyY",ctrl:!0})])}handle(e,t,n,o,r,a){const d=a.editor.section;if(null!=d)if("KeyY"==t||r){const e=d.redo();null!=e?(0,toast_1.createToast)("Redone: "+e):(0,toast_1.createToast)("Cannot redo any further")}else{const e=d.undo();null!=e?(0,toast_1.createToast)("Undone: "+e):(0,toast_1.createToast)("Cannot undo any further")}}}exports.UndoHandler=UndoHandler},{"../components/toast":19,"./command-handler":2}],15:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.Header=void 0;const dow_1=require("../data/dow"),generalDirNames={up:"Up",down:"Down"};exports.Header=class{constructor(e,t,a,n,o){this.newTimetableButton=document.getElementById(e),this.importButton=document.getElementById(t),this.exportButton=document.getElementById(a),this.tabs=document.getElementById(n),this._callback=o}set newTimetableButtonEnabled(e){this.newTimetableButton.disabled=!e}set importButtonEnabled(e){this.importButton.disabled=!e}set exportButtonEnabled(e){this.exportButton.disabled=!e}clearTabs(){this.tabs.replaceChildren()}createTabs(e,t){this.tabs.replaceChildren(...e.map(e=>this.createTabGroup(e,t)))}selectTab(e,t){document.querySelector(`#tab-group-${e} input[value="${t}"]`).checked=!0}createTabGroup(e,t){const a=document.createElement("div"),n=(a.className="tab-group",a.id="tab-group-"+e,document.createElement("div")),o=(n.className="tab-group-header",document.createElement("p"));return o.textContent=generalDirNames[e]+":",n.append(o),a.append(n),a.append(...t.map(t=>{const a=document.createElement("label"),n=(a.className="tab",document.createElement("input")),o=(n.type="radio",n.name="tab",n.autocomplete="off",n.value=t,n.addEventListener("click",()=>this._callback(e,t)),document.createElement("div")),c=(o.className="tab-content",document.createElement("p"));return c.textContent=(0,dow_1.nameDOW)(t),o.append(c),a.append(n,o),a})),a}}},{"../data/dow":20}],16:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.NewTimetableDialog=void 0;const dow_1=require("../data/dow");exports.NewTimetableDialog=class{constructor(e,t){this._dialog=document.getElementById(e),this._cancelButton=document.getElementById(e+"-cancel"),this._submitButton=document.getElementById(e+"-submit"),this._linesSelect=document.getElementById(e+"-lines"),this._dowsSelect=document.getElementById(e+"-dows"),this._idInput=document.getElementById(e+"-id"),this._errorText=document.getElementById(e+"-error"),this.submitted=t}init(e){e=[...e.lines].sort((e,t)=>e.name.localeCompare(t.name)).map(e=>new Option(e.name,e.id.toString())),this._linesSelect.replaceChildren(...e),e=dow_1.DOWPresets.map((e,t)=>new Option(e.map(e=>(0,dow_1.nameDOW)(e)).join(", "),t.toString()));this._dowsSelect.replaceChildren(...e),this._cancelButton.addEventListener("click",()=>{this._dialog.close()}),this._submitButton.addEventListener("click",()=>{var e=this._linesSelect.value,t=this._dowsSelect.value,i=this._idInput.value,s=parseInt(e),t=parseInt(t);try{this.submitted(s,t,i),this._dialog.close(),this._errorText.textContent=""}catch(e){this._errorText.textContent=e.message}})}show(){this._dialog.showModal(),this._errorText.textContent=""}isOpen(){return 1==this._dialog.open}}},{"../data/dow":20}],17:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.PasteIssuesDialog=void 0;exports.PasteIssuesDialog=class{constructor(e){this._htmlID=e,this._dialog=document.getElementById(e),this._cancelButton=document.getElementById(e+"-cancel"),this._submitButton=document.getElementById(e+"-submit"),this._duplicatesDiv=document.getElementById(e+"-duplicates")}init(){this._cancelButton.addEventListener("click",()=>{this._dialog.close()}),this._submitButton.addEventListener("click",()=>{var e=this.duplicates.map(e=>{var t=document.getElementById(this.selectID(e.rowIndex)),t=e.options[parseInt(t.value)];return{rowIndex:e.rowIndex,option:t}});this.submitted(e),this._dialog.close()})}show(e,t){this.duplicates=e,this.submitted=t,this._duplicatesDiv.replaceChildren(),e.forEach(e=>{const t=document.createElement("h2"),s=(t.textContent=`Multiple rows found for "${e.stopName}"`,document.createElement("div")),i=(s.className="select-wrapper",document.createElement("div")),n=(i.className="select-wrapper-highlight",document.createElement("div")),o=(n.className="select-wrapper-arrow",document.createElement("select"));o.id=this.selectID(e.rowIndex),o.autocomplete="off",o.replaceChildren(...e.options.map((e,t)=>{var s=e.header.endsWith(" dep");return new Option(`Use "${e.header}"`,t.toString(),s,s)})),s.append(o,i,n),this._duplicatesDiv.append(t,s)}),this._dialog.showModal()}isOpen(){return 1==this._dialog.open}selectID(e){return this._htmlID+"-duplicate-"+e}}},{}],18:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.StatusScreens=void 0;exports.StatusScreens=class{constructor(e,t,s){this._status=document.getElementById(e),this._statusLoading=document.getElementById(e+"-loading"),this._statusReady=document.getElementById(e+"-ready"),this._editor=t,this._header=s}loading(){this._status.classList.remove("gone"),this._statusLoading.classList.remove("gone"),this._statusReady.classList.add("gone"),this._header.newTimetableButtonEnabled=!1,this._header.importButtonEnabled=!1,this._header.exportButtonEnabled=!1,this._header.clearTabs(),this._editor.clear(),window.onbeforeunload=null}ready(){this._status.classList.remove("gone"),this._statusLoading.classList.add("gone"),this._statusReady.classList.remove("gone"),this._header.newTimetableButtonEnabled=!0,this._header.importButtonEnabled=!0,this._header.exportButtonEnabled=!1,this._header.clearTabs(),this._editor.clear(),window.onbeforeunload=null}editing(e){this._status.classList.add("gone"),this._header.newTimetableButtonEnabled=!0,this._header.importButtonEnabled=!0,this._header.exportButtonEnabled=!0,this._header.createTabs(e.generalDirs,e.dows),window.onbeforeunload=()=>{if(e.hasContent())return!0}}editingSection(e,t,s){t&&this._header.selectTab(e.generalDir,e.dow),this._editor.setSection(e,s)}}},{}],19:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.createToast=void 0,exports.createToast=function(e){const t=document.getElementById("toasts"),o=document.createElement("div"),s=(o.className="toast",document.createElement("p"));s.textContent=e,o.append(s),t.append(o),setTimeout(()=>{o.remove()},1e4),document.querySelectorAll("#toasts .toast:not(:nth-last-child(-n + 5))").forEach(e=>e.remove())}},{}],20:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.validateDOW=exports.nameDOW=exports.DOWPresets=void 0,exports.DOWPresets=[["MTWT___","____F__","_____S_","______S"],["MTWTF__","_____S_","______S"],["MTWTFSS"],["M______","_TWT___","____F__","_____S_","______S"],["M______","_TWTF__","_____S_","______S"],["M______","_T_____","__W____","___T___","____F__","_____S_","______S"]];const DOWNames={M______:"Mon",_T_____:"Tue",__W____:"Wed",___T___:"Thu",____F__:"Fri",_____S_:"Sat",______S:"Sun",MTWT___:"Mon-Thu",MTWTF__:"Mon-Fri",MTWTFSS:"Mon-Sun",_TWT___:"Tue-Thu",_TWTF__:"Tue-Fri"};exports.nameDOW=function(_){if(_ in DOWNames)return DOWNames[_];throw new Error(`Days of week value "${_}" is invalid or not supported`)},exports.validateDOW=function(_){if(/^(M|_)(T|_)(W|_)(T|_)(F|_)(S|_)(S|_)$/.test(_))return _;throw new Error(`Invalid days of week value: "${_}"`)}},{}],21:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.exportTimetable=void 0;const timetable_validation_1=require("./timetable-validation");function kebabify(e){return e.toLowerCase().replace(/\s+/g,"-").replace(/[^0-9a-z-]/g,"_")}exports.exportTimetable=function(e,t){const n=(0,timetable_validation_1.validateTimetable)(e,t),i=t.line(e.lineID);if(n.some(e=>!e.isValid()))throw new Error("Some timetable sections are invalid");let o="";o+="[timetable]\nversion: 2\n"+`created: ${new Date(Date.now()).toISOString().split("T")[0]}
`+`id: ${e.timetableID.toFixed()}
`+`line: ${i.id.toFixed()}
`+"type: main\nbegins: *\nends: *\n";for(const a in e.sections){var r=e.sections[a],d=n[a];for(const e of[...new Set(d.directions)])o+=function(e,t,n,i){const o=e.stops.map(e=>e.toFixed().padStart(4,"0")+" "+kebabify(n.stopName(e))),a=Math.max(...o.map(e=>e.length)),r=o.map(e=>e.padEnd(a," "));let d=t.map((e,t)=>({service:e,nextDayThreshold:i.nextDayThresholds[t]}));d=d.filter((t,n)=>i.directions[n]===e.id);for(const n of d)for(const i in e.stops){const o=e.stops[i],a=n.service.times[t.stops.indexOf(o)],d="-"===a||parseInt(i)<n.nextDayThreshold?a:">"+a;r[i]+=" "+d.padEnd(6," ")}return`
[${e.id}, ${t.dow}]
${r.join("\n")}
`}(i.directions.find(t=>t.id===e),r,t,d)}!function(e,t){const n=new Blob([e],{type:"text/plain"}),i=URL.createObjectURL(n),o=document.createElement("a");o.href=i,o.download=t,document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(i)}(o,`${e.timetableID.toString(36).padStart(2,"0")}-${kebabify(i.name)}.ttbl`)}},{"./timetable-validation":27}],22:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.openImportDialog=void 0;const timetable_1=require("./timetable");exports.openImportDialog=function(e,t){!function(e){const t=document.createElement("input");t.type="file",t.accept=".ttbl",t.click(),t.addEventListener("change",async()=>{e(await t.files[0].text())})}(o=>{console.log(o);o=new timetable_1.Timetable(0,1,["M______"],e);t(o)})}},{"./timetable":28}],23:[function(require,module,exports){"use strict";function getUpStopLists(t,e){const i=e.lines.find(e=>e.id===t);return function(t,e){if("linear"===t)return["up"];if("city-loop"===t)return["up-direct","up-via-loop"];if("branch"===t)return e.filter(t=>t.endsWith("-up"));throw new Error(`Route types of "${t}" are not supported.`)}(i.routeType,i.directions.map(t=>t.id)).map(t=>[...i.directions.find(e=>e.id===t).stops])}Object.defineProperty(exports,"__esModule",{value:!0}),exports.linearizeStopIDs=void 0,exports.linearizeStopIDs=function(t,e){const i=getUpStopLists(t,e);if(1==i.length)return i[0];let o=0;const n=[];for(;0<i.length;)if(0===i[o].length)i.splice(o,1),o=0;else{const t=i[o][0],e=i.findIndex((e,i)=>i!==o&&1<=e.indexOf(t));-1===e?(n.push(t),i.forEach(e=>{e[0]===t&&e.splice(0,1)})):(i[o].splice(0,1),o=e)}return function(t,e,i){const o=getUpStopLists(t,e);for(const t of o){let e=-1;for(const o of t){const t=i.indexOf(o);if(-1==t||t<=e)throw new Error('Cannot find linear order of stops to form the "up" and "down" directions');e=t}}}(t,e,n),n}},{}],24:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.Network=void 0;exports.Network=class Network{constructor(t="api.trainarrives.in"){this.domain=t,this._json=null}async load(){const t=await fetch(`https://${this.domain}/network/v1`);if(200!=t.status)throw new Error(`"${this.domain}" did not respond.`);this._json=await t.json()}get lines(){if(null==this._json)throw new Error("Network not loaded.");return this._json.lines}stopName(t){if(null==this._json)throw new Error("Network not loaded.");var o=this._json.stops.find(o=>o.id===t);if(null==o)throw new Error("No stop with id="+t);return o.name}line(t){return this._json.lines.find(o=>o.id==t)}directionsForLine(t){return this._json.lines.find(o=>o.id==t).directions}toJSON(){return{domain:this.domain,json:this._json}}static fromJSON(t){const o=new Network(t.domain);return o._json=t.json,o}}},{}],25:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.Service=exports.TimetableData=void 0;exports.TimetableData=class TimetableData{constructor(e=[]){this._services=e.map(e=>e.clone())}cell(e,s){return this._services[e].times[s]}service(e){return this._services[e].clone()}nextDay(e){return this._services[e].nextDay}map(e){return this._services.map((s,t)=>e(s.clone(),t))}filter(e){return this._services.map(e=>e.clone()).filter((s,t)=>e(s,t))}addServices(e,s){null==s?this._services.push(...e.map(e=>e.clone())):this._services.splice(s,0,...e.map(e=>e.clone()))}deleteServices(e,s){null==s?this._services.splice(e,1):this._services.splice(e,s-e)}replaceService(e,s){this._services[s]=e.clone()}replaceCell(e,s,t){this._services[e].times[s]=t}modifyCell(e,s,t){this._services[e].times[s]=t(this._services[e].times[s])}modifyCells(e,s,t,i,r){for(let c=Math.min(e,t);c<=Math.max(e,t);c++)for(let e=Math.min(s,i);e<=Math.max(s,i);e++)this._services[c].times[e]=r(this._services[c].times[e],c,e)}setNextDay(e,s){this._services[e].nextDay=s}clone(){return new TimetableData(this._services)}get width(){return this._services.length}toJSON(){return{services:this._services}}static fromJSON(e){return new TimetableData(e.services.map(e=>Service.fromJSON(e)))}};class Service{constructor(e,s){this.times=e,this.nextDay=s}clone(){return new Service([...this.times],this.nextDay)}static fromJSON(e){return new Service(e.times,e.nextDay)}}exports.Service=Service},{}],26:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.TimetableSection=void 0;const dow_1=require("./dow"),timetable_data_1=require("./timetable-data");exports.TimetableSection=class TimetableSection{constructor(t,e,a){this.generalDir=t,this.dow=(0,dow_1.validateDOW)(e),this._data=new timetable_data_1.TimetableData,this.stops=a,this.undoFrames=[],this.redoFrames=[]}edit(t,e){for(this.undoFrames.push({actionName:t,before:this._data});10<this.undoFrames.length;)this.undoFrames.shift();this.redoFrames=[],t=this._data.clone(),e(t),this._data=t,this.changed&&this.changed()}undo(){var t=this.undoFrames.pop();return null==t?null:(this.redoFrames.push({actionName:t.actionName,after:this._data}),this._data=t.before,this.changed&&this.changed(),t.actionName)}redo(){var t=this.redoFrames.pop();return null==t?null:(this.undoFrames.push({actionName:t.actionName,before:this._data}),this._data=t.after,this.changed&&this.changed(),t.actionName)}cell(t,e){return this._data.cell(t,e)}service(t){return this._data.service(t)}nextDay(t){return this._data.nextDay(t)}map(t){return this._data.map(t)}filter(t){return this._data.filter(t)}toJSON(){return{generalDir:this.generalDir,dow:this.dow,stops:this.stops,data:this._data.toJSON()}}static fromJSON(t){const e=new TimetableSection(t.generalDir,t.dow,t.stops);return e._data=timetable_data_1.TimetableData.fromJSON(t.data),e}get width(){return this._data.width}get height(){return this.stops.length}}},{"./dow":20,"./timetable-data":25}],27:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.ValidationResults=exports.validateSection=exports.validateTimetable=void 0;const utils_1=require("../utils");function validateSection(e,r,t){var s=new ValidationResults(e.width,e.height);return function(e,r){for(const t of(0,utils_1.range)(0,e.height))(0,utils_1.range)(0,e.width).some(r=>""==e.cell(r,t))&&r.reportStopError(t,"Stop has missing values")}(e,s),function(e,r){for(const t of(0,utils_1.range)(0,e.width)){const s=e.service(t);for(const i of(0,utils_1.range)(0,t)){const o=e.service(i);s.nextDay==o.nextDay&&s.times.every((e,r)=>e==o.times[r])&&r.reportServiceError(t,"Duplicated service")}}}(e,s),function(e,r,t,s){var i=r.line(t);for(const r of(0,utils_1.range)(0,e.width)){const t=e.service(r),o=/^((2[0-3]|[01][0-9]):[0-5][0-9]|-)$/;if(t.times.every(e=>""==e||o.test(e))){if(!t.times.some(e=>""==e)){const o=function(e,r,t){const s=e.filter((e,t)=>"-"!=r.times[t]);if(s.length<2)return null;const i=t.filter(e=>e.stops.filter(e=>s.includes(e)).every((e,r)=>s[r]===e));return 0==i.length?null:i.sort((e,r)=>e.stops.length-r.stops.length)[0].id}(e.stops,t,i.directions);if(null==o)s.reportServiceError(r,"Service direction unrecognized");else{s.reportServiceDirection(r,o,function(e,r){return"city-loop"===r.routeType?e.endsWith("-via-loop")?r.routeLoopPortal+"-via-loop":r.routeLoopPortal+"-direct":"branch"===r.routeType&&2==r.directions.length?e===r.directions[0].id?"branch-a":"branch-b":null}(o,i));const e=function(e){const r=[];let t=0;for(let s=0;s<e.times.length;s++){var i;"-"===e.times[s]?r.push(t):(i=(0,utils_1.parseMinuteOfDay)(e.times[s]),r.push(i),t=i)}const s=[];for(let e=1;e<r.length;e++)r[e-1]>r[e]&&s.push(e);return e.nextDay&&0===s.length?0:e.nextDay||0!==s.length?e.nextDay||1!==s.length?null:s[0]:r.length}(t);null==e?s.reportServiceError(r,"Time travel required (service spans too many days)"):s.reportNextDayThreshold(r,e)}}}else s.reportServiceError(r,"Cells contain invalid values")}}(e,r,t,s),s}exports.validateTimetable=function(e,r){return e.sections.map(t=>validateSection(t,r,e.lineID))},exports.validateSection=validateSection;class ValidationResults{constructor(e,r){this.stopErrors=(0,utils_1.repeat)(null,r),this.serviceErrors=(0,utils_1.repeat)(null,e),this.nextDayThresholds=(0,utils_1.repeat)(null,e),this.directions=(0,utils_1.repeat)(null,e),this.directionsIcons=(0,utils_1.repeat)(null,e)}reportStopError(e,r){this.stopErrors[e]=r}reportServiceError(e,r){this.serviceErrors[e]=r}reportServiceDirection(e,r,t){this.directions[e]=r,this.directionsIcons[e]=t}reportNextDayThreshold(e,r){this.nextDayThresholds[e]=r}isValid(){return this.stopErrors.every(e=>null==e)&&this.serviceErrors.every(e=>null==e)&&this.directions.every(e=>null!=e)}overallError(){let e=null;if(null==(e=null==(e=null==e?this.stopErrors.find(e=>null!=e):e)?this.serviceErrors.find(e=>null!=e):e))return null;var r=this.stopErrors.filter(e=>null!=e).length+this.serviceErrors.filter(e=>null!=e).length-1;return 0==r?e:1==r?e+" + 1 other error":e+` + ${r} other errors`}toJSON(){return{stopErrors:this.stopErrors,serviceErrors:this.serviceErrors,nextDayThresholds:this.nextDayThresholds,directionsIcons:this.directionsIcons}}static fromJSON(e){const r=new ValidationResults(e.serviceErrors.length,e.stopErrors.length);return r.stopErrors=e.stopErrors,r.serviceErrors=e.serviceErrors,r.nextDayThresholds=e.nextDayThresholds,r.directionsIcons=e.directionsIcons,r}}exports.ValidationResults=ValidationResults},{"../utils":35}],28:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.Timetable=void 0;const utils_1=require("../utils"),linearize_stops_1=require("./linearize-stops"),timetable_section_1=require("./timetable-section");exports.Timetable=class{constructor(e,t,i,s){this.timetableID=(0,utils_1.validateTimetableID)(e),this.lineID=(0,utils_1.validateLineID)(t,s),this._dows=i,this.sections=[];e=(0,linearize_stops_1.linearizeStopIDs)(t,s);this.linearizedStops={up:e,down:[...e].reverse()},i.forEach(e=>{this.sections.push(new timetable_section_1.TimetableSection("up",e,this.linearizedStops.up)),this.sections.push(new timetable_section_1.TimetableSection("down",e,this.linearizedStops.down))})}get generalDirs(){return["up","down"]}get dows(){return[...this._dows]}getTimetableSection(e,t){var i=this.sections.find(i=>i.generalDir===e&&i.dow===t);if(null!=i)return i;throw new Error(`Timetable section in generalDir="${e}", `+`dow="${t}" does not exist`)}hasContent(){return this.sections.some(e=>0!=e.width)}}},{"../utils":35,"./linearize-stops":23,"./timetable-section":26}],29:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.css=void 0,exports.css={text:"hsla(220deg, 100%, 4%, 0.8)",paper10:"hsl(220deg, 30%, 93.5%)",accent:"#00a5ca",hoverHighlight:"hsla(220deg, 100%, 18%, 0.1)"}},{}],30:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.EditorGrid=exports.COL_SIZE=exports.ROW_SIZE=void 0;const editor_grid_css_1=require("./editor-grid-css");exports.ROW_SIZE=20,exports.COL_SIZE=48;exports.EditorGrid=class{constructor(t,e,s){this._editor=t,this._grid=document.getElementById(e),this._canvas=document.getElementById(s),this._context=this._canvas.getContext("2d"),this.resetEvents()}resetEvents(){this._selected=null,this._dragging=!1,this.resetMouseOver()}resetMouseOver(){this._mouseOver=null}init(){this._canvas.addEventListener("mousedown",t=>{t=this.relativeCoords(t);this._selected={startX:t.x,startY:t.y,endX:t.x,endY:t.y},this._dragging=!0,this.draw()}),this._canvas.addEventListener("mouseup",t=>{t=this.relativeCoords(t);this._selected.endX=t.x,this._selected.endY=t.y,this._dragging=!1,this.draw()}),this._canvas.addEventListener("mousemove",t=>this.onMouseMove(t)),this._canvas.addEventListener("mouseenter",t=>this.onMouseMove(t)),this._canvas.addEventListener("mouseleave",()=>{this._mouseOver=null,this.draw()})}draw(){var t,e,s;const i=this._editor.section,o=null!=(t=null==i?void 0:i.width)?t:0,r=null!=(e=null==i?void 0:i.height)?e:0,h=this.calculateDpiRatio(),n=this.getOnScreenCells(r,o);if(this._grid.style.width=exports.COL_SIZE*o+"px",this._grid.style.height=exports.ROW_SIZE*r+"px",this._canvas.width=exports.COL_SIZE*n.width*h,this._canvas.height=exports.ROW_SIZE*n.height*h,this._canvas.style.width=exports.COL_SIZE*n.width+"px",this._canvas.style.height=exports.ROW_SIZE*n.height+"px",this._canvas.style.left=exports.COL_SIZE*n.x1+"px",this._canvas.style.top=exports.ROW_SIZE*n.y1+"px",this._context.clearRect(0,0,this._canvas.width,this._canvas.height),this._context.translate(-n.x1*exports.COL_SIZE*h,-n.y1*exports.ROW_SIZE*h),this._context.scale(h,h),null!=i){this._context.fillStyle=editor_grid_css_1.css.paper10;for(let t=n.y1;t<n.y2;t++)t%2==0&&this._context.fillRect(n.x1*exports.COL_SIZE,t*exports.ROW_SIZE,n.width*exports.COL_SIZE,exports.ROW_SIZE);this._context.font="0.7rem 'Roboto Mono', monospace";for(let t=n.x1;t<n.x2;t++){const e=null!=(s=this._nextDayThresholds[t])?s:i.height;for(let s=n.y1;s<n.y2;s++){this._context.fillStyle=s<e?editor_grid_css_1.css.text:editor_grid_css_1.css.accent;const o=i.cell(t,s),r=this._context.measureText(o).width;this._context.fillText(o,t*exports.COL_SIZE+(exports.COL_SIZE-r)/2,s*exports.ROW_SIZE+14)}}if(this._context.fillStyle=editor_grid_css_1.css.hoverHighlight,null!=this._mouseOver&&this._context.fillRect(this._mouseOver.x*exports.COL_SIZE,this._mouseOver.y*exports.ROW_SIZE,exports.COL_SIZE,exports.ROW_SIZE),this._context.lineWidth=Math.round(1.5*h)/h,this._context.strokeStyle=editor_grid_css_1.css.accent,null!=this._selected){const t=Math.min(this._selected.startX,this._selected.endX),e=Math.max(this._selected.startX,this._selected.endX)-t+1,s=Math.min(this._selected.startY,this._selected.endY),i=Math.max(this._selected.startY,this._selected.endY)-s+1;this._context.strokeRect(t*exports.COL_SIZE,s*exports.ROW_SIZE,e*exports.COL_SIZE,i*exports.ROW_SIZE)}}}relativeCoords(t){var e=this._grid.getBoundingClientRect(),s=t.clientX-e.left,t=t.clientY-e.top;return{x:Math.floor(s/exports.COL_SIZE),y:Math.floor(t/exports.ROW_SIZE)}}onMouseMove(t){this._mouseOver=this.relativeCoords(t),this._dragging&&(1!=t.buttons?this._dragging=!1:(this._selected.endX=this._mouseOver.x,this._selected.endY=this._mouseOver.y)),this.draw()}calculateDpiRatio(){return(window.devicePixelRatio||1)/(this._context.backingStorePixelRatio||1)}getOnScreenCells(t,e){var s=this._editor.clientSize(),i=this._editor.scrollPos(),o=s.width-this._editor.stops.clientWidth(),s=s.height-this._editor.services.clientHeight(),h=Math.max(0,Math.floor(i.y/exports.ROW_SIZE)),t=Math.min(t,h+Math.ceil(s/exports.ROW_SIZE)+1),s=t-h,i=Math.max(0,Math.floor(i.x/exports.COL_SIZE)),e=Math.min(e,i+Math.ceil(o/exports.COL_SIZE)+1);return{x1:i,x2:e,y1:h,y2:t,width:e-i,height:s}}get selected(){return null==this._selected?null:Object.assign({},this._selected)}get selectedRange(){return null==this._selected?null:{x1:Math.min(this._selected.startX,this._selected.endX),y1:Math.min(this._selected.startY,this._selected.endY),x2:Math.max(this._selected.startX,this._selected.endX),y2:Math.max(this._selected.startY,this._selected.endY)}}select(t,e,s,i){this._selected={startX:t,startY:e,endX:null!=s?s:t,endY:null!=i?i:e},this.draw()}clearSelection(){this._selected=null,this.draw()}setNextDayThresholds(t){this._nextDayThresholds=t,this.draw()}}},{"./editor-grid-css":29}],31:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.EditorServices=void 0;exports.EditorServices=class{constructor(e){this._servicesDiv=document.getElementById(e),this._currNextDay=[]}clear(){this.setServices([])}setServices(e){e.length==this._currNextDay.length&&e.every((e,r)=>this._currNextDay[r]==e)||(this._currNextDay=e,this._servicesDiv.replaceChildren(...e.map(e=>this.makeButton(e))))}markErrorServices(e){this._servicesDiv.querySelectorAll(".service").forEach((r,t)=>{e[t]?r.classList.add("error"):r.classList.remove("error")})}markServiceDirectionIcons(e){this._servicesDiv.querySelectorAll(".service .direction-icon").forEach((r,t)=>{const i=r;null==e[t]?i.classList.add("gone"):(i.src=`service-icons/${e[t]}.svg`,i.classList.remove("gone"))})}makeButton(e){const r=document.createElement("button"),t=(r.className="service",document.createElement("img"));if(t.className="direction-icon gone",t.alt="Service direction indicator",r.append(t),e){const e=document.createElement("img");e.src="service-icons/next-day.svg",e.alt="Next day",r.append(e)}return r.addEventListener("click",()=>{var e;null!=this.serviceClicked&&(e=Array.from(r.parentElement.children).indexOf(r),this.serviceClicked(e))}),r}clientHeight(){return this._servicesDiv.getBoundingClientRect().height}}},{}],32:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.EditorStops=void 0;exports.EditorStops=class{constructor(t){this._stopsDiv=document.getElementById(t)}clear(){this.setStops([])}setStops(t){this._stopsDiv.replaceChildren(...t.map((t,e)=>{const s=document.createElement("button"),o=(s.className="stop",document.createElement("p"));return o.textContent=t,s.append(o),s.addEventListener("click",()=>{null!=this.stopClicked&&this.stopClicked(e)}),s}))}markErrorStops(t){this._stopsDiv.querySelectorAll(".stop").forEach((e,s)=>{t[s]?e.classList.add("error"):e.classList.remove("error")})}clientWidth(){return this._stopsDiv.getBoundingClientRect().width}}},{}],33:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.Editor=void 0;const utils_1=require("../utils"),editor_grid_1=require("./editor-grid"),editor_services_1=require("./editor-services"),editor_stops_1=require("./editor-stops");exports.Editor=class{constructor(i,t,e,s,r){this._editorDiv=document.getElementById(i),this.grid=new editor_grid_1.EditorGrid(this,t,e),this.stops=new editor_stops_1.EditorStops(s),this.services=new editor_services_1.EditorServices(r),this.section=null}init(){this.grid.init(),this._editorDiv.addEventListener("scroll",()=>{this.grid.resetMouseOver(),this.grid.draw()});var i=i=>this.onScrollWheel(i);this._editorDiv.addEventListener("mousewheel",i,!1),this._editorDiv.addEventListener("DOMMouseScroll",i,!1),this.stops.stopClicked=i=>this.onStopClicked(i),this.services.serviceClicked=i=>this.onServiceClicked(i),this.grid.draw()}resize(){this.grid.resetMouseOver(),this.grid.draw()}clear(){null!=this.section&&(this.section.changed=null),this.section=null,this.stops.clear(),this.services.clear(),this.grid.resetEvents(),this.grid.setNextDayThresholds([]),this.grid.draw()}setSection(i,t){null!=this.section&&(this.section.changed=null),this.section=i,this.stops.setStops(i.stops.map(i=>t.stopName(i))),this.services.setServices(this.section.map(i=>i.nextDay)),this.section.changed=()=>this.onChanged(),this.grid.resetEvents(),this.grid.draw(),this.requestValidation()}applyValidationOverlay(i){this.stops.markErrorStops(i.stopErrors.map(i=>null!=i)),this.services.markErrorServices(i.serviceErrors.map(i=>null!=i)),this.services.markServiceDirectionIcons(i.directionsIcons),this.grid.setNextDayThresholds(i.nextDayThresholds.map(i=>null==i?this.section.height:i))}onChanged(){this.grid.draw(),this.services.setServices(this.section.map(i=>i.nextDay)),null!=this._validationTimeoutID&&(clearTimeout(this._validationTimeoutID),this._validationTimeoutID=null),this._validationTimeoutID=setTimeout(()=>{null!=this.requestValidation&&this.requestValidation()},500)}onServiceClicked(i){this.grid.select(i,0,i,this.section.height-1)}onStopClicked(i){0!=this.section.width&&this.grid.select(0,i,this.section.width-1,i)}onScrollWheel(i){var t=i=window.event||i,t=(0,utils_1.clamp)(t.wheelDelta||-t.detail,-1,1);this._editorDiv.scrollLeft-=64*t,i.preventDefault()}clientSize(){return this._editorDiv.getBoundingClientRect()}scrollPos(){return{x:this._editorDiv.scrollLeft,y:this._editorDiv.scrollTop}}}},{"../utils":35,"./editor-grid":30,"./editor-services":31,"./editor-stops":32}],34:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.AppContext=void 0;const editor_1=require("./editor/editor"),header_1=require("./components/header"),network_1=require("./data/network"),command_listener_1=require("./commands/command-listener"),status_screens_1=require("./components/status-screens"),new_timetable_dialog_1=require("./components/new-timetable-dialog"),paste_issues_dialog_1=require("./components/paste-issues-dialog"),timetable_1=require("./data/timetable"),dow_1=require("./data/dow"),validator_1=require("./validator"),export_1=require("./data/export"),import_1=require("./data/import");class AppContext{constructor(){this.network=null,this.timetable=null,this.editor=new editor_1.Editor("editor","grid","grid-canvas","stops","services"),this.validator=new validator_1.Validator("validation-worker.js"),this.header=new header_1.Header("new-timetable-button","import-button","export-button","tabs",(e,t)=>this.tabClicked(e,t)),this.status=new status_screens_1.StatusScreens("status",this.editor,this.header),this.newTimetableDialog=new new_timetable_dialog_1.NewTimetableDialog("new-timetable-dialog",(e,t,i)=>this.newTimetableDialogSubmitted(e,t,i)),this.pasteIssuesDialog=new paste_issues_dialog_1.PasteIssuesDialog("paste-issues-dialog")}init(e){this.network=e,this.validator.init(this.network),this.editor.init(),this.editor.requestValidation=()=>{this.validator.requestValidation(this.editor.section,this.timetable.lineID)},window.addEventListener("resize",()=>this.editor.resize()),this.validator.onResults=e=>{const t=e.overallError(),i=document.querySelector("#footer p");null==t?(i.classList.remove("error"),i.textContent="Valid timetable"):(i.classList.add("error"),i.textContent=t),this.editor.applyValidationOverlay(e)},this.newTimetableDialog.init(this.network),this.pasteIssuesDialog.init(),this.header.newTimetableButton.addEventListener("click",()=>{null!=this.timetable&&this.timetable.hasContent()&&!confirm("Create a new timetable? This one won't be saved anywhere.")||this.newTimetableDialog.show()}),this.header.importButton.addEventListener("click",()=>{(0,import_1.openImportDialog)(this.network,e=>{this.editTimetable(e)})}),this.header.exportButton.addEventListener("click",()=>{try{(0,export_1.exportTimetable)(this.timetable,this.network)}catch(e){alert(e)}}),this.status.ready()}newTimetableDialogSubmitted(e,t,i){i=parseInt(i,36),t=dow_1.DOWPresets[t],i=new timetable_1.Timetable(i,e,t,this.network);this.editTimetable(i)}editTimetable(e){this.timetable=e,this.status.editing(this.timetable);e=this.timetable.getTimetableSection(this.timetable.generalDirs[0],this.timetable.dows[0]);this.status.editingSection(e,!0,this.network)}tabClicked(e,t){e=this.timetable.getTimetableSection(e,t);this.status.editingSection(e,!1,this.network)}}exports.AppContext=AppContext;const network=new network_1.Network,appContext=new AppContext,commandListener=new command_listener_1.CommandListener;network.load().then(()=>{appContext.init(network),commandListener.init(appContext),document.addEventListener("keydown",e=>commandListener.onDocKeyEvent(e)),document.addEventListener("paste",e=>commandListener.onPaste(e))})},{"./commands/command-listener":3,"./components/header":15,"./components/new-timetable-dialog":16,"./components/paste-issues-dialog":17,"./components/status-screens":18,"./data/dow":20,"./data/export":21,"./data/import":22,"./data/network":24,"./data/timetable":28,"./editor/editor":33,"./validator":36}],35:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.standardizeTimeString=exports.parseMinuteOfDay=exports.repeat=exports.range=exports.clamp=exports.validateLineID=exports.validateTimetableID=void 0,exports.validateTimetableID=function(e){if(isNaN(e))throw new Error("No timetable ID given");if(1295<e||e<0)throw new Error("Timetable ID must be 0-1295 to fit within two base-36 "+`digits (given ${e})`);return e},exports.validateLineID=function(e,t){if(t.lines.every(t=>t.id!==e))throw new Error("There is no line with id="+e);return e},exports.clamp=function(e,t,r){var a=Math.min(t,r),t=Math.max(t,r);return Math.min(Math.max(e,a),t)},exports.range=function(e,t){return[...Array(t-e).keys()].map(t=>t+e)},exports.repeat=function(e,t){const r=[];for(let a=0;a<t;a++)r.push(e);return r},exports.parseMinuteOfDay=function(e){var t=e.split(":"),r=parseInt(t[0]),t=parseInt(t[1]);if(isNaN(r)||isNaN(t)||r<0||t<0||23<r||59<t)throw new Error(`"${e}" is not a valid time of day`);return 60*r+t},exports.standardizeTimeString=function(e){if(!/^[0-9]{1,2}:[0-9]{2}(am|pm)?$/g.test(e))return null;const t=e.split(":");let r=parseInt(t[0]);const a=parseInt(t[1].replace("am","").replace("pm",""));return(e.endsWith("am")||e.endsWith("pm"))&&(r%=12,e.endsWith("pm")&&(r+=12)),r<0||24<=r||a<0||60<=a?null:r.toFixed().padStart(2,"0")+":"+a.toFixed().padStart(2,"0")}},{}],36:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.Validator=void 0;const timetable_validation_1=require("./data/timetable-validation");exports.Validator=class{constructor(t){this._worker=new Worker(t),this._worker.onmessage=t=>{this.onResults&&this.onResults(timetable_validation_1.ValidationResults.fromJSON(t.data))}}init(t){this._worker.postMessage({network:t.toJSON()})}requestValidation(t,e){this._worker.postMessage({section:t.toJSON(),lineID:e})}}},{"./data/timetable-validation":27}]},{},[34]);
